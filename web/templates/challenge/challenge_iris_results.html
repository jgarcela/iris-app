{% extends "challenge/challenge_base.html" %}

{% block title %}{{ _('Resultados del Análisis con IRIS') }} - {{ text_data.title }}{% endblock %}

{% block challenge_content %}
<div class="container-fluid py-4">
    <!-- Header de Resultados -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-1">
                        <i class="fas fa-robot me-2 text-primary"></i>
                        {{ _('Resultados del Análisis con IRIS') }}
                    </h2>
                    <p class="text-muted mb-0">
                        {{ text_data.title }}
                    </p>
                </div>
                <div>
                    {% if next_text_id %}
                        <a href="{{ url_for('challenge.analyze_text', text_id=next_text_id) }}" class="btn btn-primary">
                            <i class="fas fa-arrow-right me-2"></i>
                            {{ _('Siguiente Texto') }}
                        </a>
                    {% else %}
                        <a href="{{ url_for('challenge.challenge_home') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-check me-2"></i>
                            {{ _('Finalizar') }}
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Comparación de Análisis -->
    <div class="row">
        <!-- Análisis Manual -->
        <div class="col-lg-6 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-user-edit me-2"></i>
                        {{ _('Tu Análisis Manual') }}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="text-visualization">
                        <p><strong>{{ _('Texto con tus anotaciones:') }}</strong> <span id="manual-annotations-count" class="badge bg-primary">0</span></p>
                        <div id="manual-text-highlights" class="highlighted-text" style="max-height: 400px; overflow-y: auto; padding: 15px; border: 1px solid #dee2e6; border-radius: 5px; background: #f8f9fa;">
                            <!-- Texto con highlights se carga aquí -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Análisis de IA -->
        <div class="col-lg-6 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-clipboard-check me-2"></i>
                        {{ _('Anotaciones IRIS') }}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="text-visualization">
                        <p><strong>{{ _('Texto con anotaciones IRIS:') }}</strong> <span id="original-annotations-count" class="badge bg-success">0</span></p>
                        <div id="original-text-highlights" class="highlighted-text" style="max-height: 400px; overflow-y: auto; padding: 15px; border: 1px solid #dee2e6; border-radius: 5px; background: #f8f9fa;">
                            <!-- Texto con highlights se carga aquí -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Métricas de Comparación -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-line me-2"></i>
                        {{ _('Métricas de Comparación') }}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-4">
                            <div class="metric-item">
                                <div class="metric-value" id="precision-score">0%</div>
                                <div class="metric-label">{{ _('Precisión') }}</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="metric-item">
                                <div class="metric-value" id="recall-score">0%</div>
                                <div class="metric-label">{{ _('Cobertura') }}</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="metric-item">
                                <div class="metric-value score-highlight" id="total-score">0%</div>
                                <div class="metric-label">{{ _('Puntuación Total') }}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Detalles del Texto Analizado -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-file-alt me-2"></i>
                        {{ _('Texto Analizado') }}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="text-content" id="analyzed-text">
                        <p>{{ text_data.text }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<style>
.analysis-summary, .ai-summary {
    min-height: 200px;
}

.annotations-list {
    max-height: 300px;
    overflow-y: auto;
}

.annotation-item {
    background: #f8f9fa;
    padding: 0.75rem;
    border-radius: 6px;
    margin-bottom: 0.5rem;
    border-left: 4px solid #007bff;
}

.annotation-text {
    font-size: 0.9rem;
    color: #495057;
    margin-bottom: 0.25rem;
}

.annotation-meta {
    font-size: 0.8rem;
    color: #6c757d;
}

.metric-item {
    padding: 1rem;
}

.metric-value {
    font-size: 2.5rem;
    font-weight: bold;
    color: #495057;
    margin-bottom: 0.5rem;
}

.metric-label {
    color: #6c757d;
    font-weight: 600;
}

.score-highlight {
    color: #28a745 !important;
}

.ai-category {
    margin-bottom: 1rem;
}

/* Styles for annotation highlights */
.highlighted-text {
    line-height: 1.8;
    font-size: 1rem;
    color: #495057;
    white-space: pre-wrap;
    word-wrap: break-word;
}

.highlighted-text mark {
    padding: 2px 4px;
    border-radius: 3px;
    font-weight: 500;
}

.mark-contenido_general {
    background-color: #d4edda;
    border-bottom: 3px solid #28a745;
}

.mark-lenguaje {
    background-color: #ffe6e6;
    border-bottom: 3px solid #dc3545;
}

.mark-fuentes {
    background-color: #e6f3ff;
    border-bottom: 3px solid #007bff;
}

.ai-category h6 {
    color: #495057;
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.ai-category ul {
    margin: 0;
    padding-left: 1.2rem;
}

.ai-category li {
    margin-bottom: 0.25rem;
    font-size: 0.9rem;
}

.text-content {
    line-height: 1.8;
    font-size: 1.1rem;
    color: #495057;
}

.action-buttons {
    margin-top: 2rem;
}
</style>

<script>
// Datos desde el backend
const manualAnnotations = {{ manual_annotations | tojson | safe }};
const originalAnnotations = {{ original_annotations | tojson | safe }};

// Variable descriptions for tooltips
const VARIABLE_DESCRIPTIONS = {
  'cita_textual_titular': 'Cita textual titular',
  'genero_nombre_propio_titular': 'Género nombre propio titular',
  'genero_periodista': 'Género periodista',
  'genero_personas_mencionadas': 'Género personas mencionadas',
  'nombre_propio_titular': 'Nombre propio titular',
  'personas_mencionadas': 'Personas mencionadas',
  'tema': 'Tema',
  'androcentrismo': 'Androcentrismo',
  'asimetria': 'Asimetría',
  'cargos_mujeres': 'Cargos mujeres',
  'comparacion_mujeres_hombres': 'Comparación mujeres/hombres',
  'denominacion_dependiente': 'Denominación dependiente',
  'denominacion_redundante': 'Denominación redundante',
  'denominacion_sexualizada': 'Denominación sexualizada',
  'dual_aparente': 'Dual aparente',
  'excepcion_noticiabilidad': 'Excepción noticiabilidad',
  'hombre_humanidad': 'Hombre humanidad',
  'infantilizacion': 'Infantilización',
  'lenguaje_sexista': 'Lenguaje sexista',
  'masculino_generico': 'Masculino genérico',
  'sexismo_social': 'Sexismo social',
  'declaracion_fuente': 'Declaración fuente',
  'genero_fuente': 'Género fuente',
  'nombre_fuente': 'Nombre fuente',
  'tipo_fuente': 'Tipo fuente'
};

document.addEventListener('DOMContentLoaded', function() {
  loadAnalysisResults();
});

function loadAnalysisResults() {
  loadManualAnnotations();
  loadOriginalAnnotations();
  calculateMetrics();
}

function loadOriginalAnnotations() {
  const container = document.getElementById('original-text-highlights');
  const countElement = document.getElementById('original-annotations-count');
  
  if (!originalAnnotations || originalAnnotations.length === 0) {
    container.innerHTML = '<p class="text-muted text-center py-3"><i class="fas fa-info-circle me-2"></i>{{ _("No hay anotaciones originales disponibles") }}</p>';
    countElement.textContent = '0';
    return;
  }
  
  countElement.textContent = originalAnnotations.length;
  
  // Get the original text
  const originalText = {{ text_data.text | tojson | safe }};
  
  // Apply highlights to text
  let highlightedText = applyAnnotationsToText(originalText, originalAnnotations);
  container.innerHTML = highlightedText;
}

function loadManualAnnotations() {
  const container = document.getElementById('manual-text-highlights');
  const countElement = document.getElementById('manual-annotations-count');
  countElement.textContent = manualAnnotations.length;
  
  if (manualAnnotations.length === 0) {
    container.innerHTML = '<p class="text-muted text-center py-3"><i class="fas fa-info-circle me-2"></i>{{ _("No se realizaron anotaciones manuales") }}</p>';
    return;
  }
  
  // Get the original text
  const originalText = {{ text_data.text | tojson | safe }};
  
  // Apply highlights to text
  let highlightedText = applyAnnotationsToText(originalText, manualAnnotations);
  container.innerHTML = highlightedText;
}

function applyAnnotationsToText(text, annotations) {
  if (!annotations || annotations.length === 0) return escapeHtml(text);
  
  // Group annotations by their text and category to avoid duplicates
  const annotationMap = new Map();
  annotations.forEach(annotation => {
    const key = `${annotation.text}|${annotation.category}`;
    if (!annotationMap.has(key)) {
      annotationMap.set(key, []);
    }
    annotationMap.get(key).push(annotation);
  });
  
  // Create sorted ranges (go backwards to avoid position shifting)
  const ranges = [];
  annotationMap.forEach((annotationList, key) => {
    const searchText = annotationList[0].text;
    let pos = text.indexOf(searchText);
    
    while (pos !== -1) {
      const category = annotationList[0].category;
      const variables = [...new Set(annotationList.map(a => a.variable))];
      const varDescriptions = variables.map(v => VARIABLE_DESCRIPTIONS[v] || v.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()));
      
      ranges.push({
        start: pos,
        end: pos + searchText.length,
        category: category,
        variables: variables.join(', '),
        varDescriptions: varDescriptions.join(', '),
        text: searchText
      });
      
      pos = text.indexOf(searchText, pos + searchText.length);
    }
  });
  
  // Sort from end to beginning
  ranges.sort((a, b) => b.start - a.start);
  
  let result = text;
  ranges.forEach(range => {
    const before = result.substring(0, range.start);
    const highlighted = `<mark class="annotation-mark mark-${range.category}" data-variable="${range.variables}" title="${range.category.replace('_', ' ')} · ${range.varDescriptions}">${escapeHtml(range.text)}</mark>`;
    const after = result.substring(range.end);
    result = before + highlighted + after;
  });
  
  return result;
}

function escapeHtml(text) {
  const map = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#039;'
  };
  return text.replace(/[&<>"']/g, m => map[m]);
}

function loadAIAnalysis() {
  const container = document.getElementById('ai-analysis-details');
  const countElement = document.getElementById('ai-variables-count');

  // Render según dificultad
  if (currentDifficulty === 'easy' && Array.isArray(aiAnalysis.sesgos)) {
    countElement.textContent = aiAnalysis.sesgos.length;
    container.innerHTML = `
      <div class="ai-category">
        <h6>{{ _("Sesgos detectados") }}</h6>
        <ul>
          ${aiAnalysis.sesgos.map(s => `<li>${s}</li>`).join('')}
        </ul>
      </div>
    `;
    return;
  }

  // Medium / Hard (categorías)
  let totalVariables = 0;
  const cg = aiAnalysis.contenido_general || {};
  const lg = aiAnalysis.lenguaje || {};
  const ft = aiAnalysis.fuentes || {};

  // Contador básico (número de campos con valor no vacío)
  [cg, lg, ft].forEach(group => {
    if (!group) return;
    Object.values(group).forEach(v => { if (v && (Array.isArray(v) ? v.length : String(v).length)) totalVariables++; });
  });
  countElement.textContent = totalVariables;

  container.innerHTML = `
    <div class="ai-category">
      <h6>{{ _("Contenido General") }}</h6>
      <ul>
        <li>{{ _("Personas mencionadas:") }} ${cg.personas_mencionadas ?? 'N/A'}</li>
        <li>{{ _("Género periodista:") }} ${cg.genero_periodista ?? 'N/A'}</li>
        <li>{{ _("Tema:") }} ${cg.tema ?? 'N/A'}</li>
      </ul>
    </div>
    <div class="ai-category">
      <h6>{{ _("Lenguaje") }}</h6>
      <ul>
        <li>{{ _("Lenguaje sexista:") }} ${lg.lenguaje_sexista ?? 'N/A'}</li>
        <li>{{ _("Androcentrismo:") }} ${lg.androcentrismo ?? 'N/A'}</li>
        <li>{{ _("Asimetría:") }} ${lg.asimetria ?? 'N/A'}</li>
        <li>{{ _("Infantilización:") }} ${lg.infantilizacion ?? 'N/A'}</li>
        <li>{{ _("Masculino genérico:") }} ${lg.masculino_generico ?? 'N/A'}</li>
      </ul>
    </div>
    <div class="ai-category">
      <h6>{{ _("Fuentes") }}</h6>
      <ul>
        <li>{{ _("Nombre fuente:") }} ${ft.nombre_fuente ?? 'N/A'}</li>
        <li>{{ _("Género fuente:") }} ${ft.genero_fuente ?? 'N/A'}</li>
        <li>{{ _("Tipo fuente:") }} ${ft.tipo_fuente ?? 'N/A'}</li>
      </ul>
    </div>
  `;
}

function calculateMetrics() {
  // Comparar anotaciones manuales con anotaciones originales
  const originalCount = originalAnnotations ? originalAnnotations.length : 0;
  
  if (originalCount === 0) {
    document.getElementById('precision-score').textContent ='N/A';
    document.getElementById('recall-score').textContent = 'N/A';
    document.getElementById('total-score').textContent = 'N/A';
    return;
  }
  
  // Crear sets de identificadores únicos para comparar
  const manualSet = new Set(manualAnnotations.map(a => `${a.category}_${a.variable}_${a.text}`));
  const originalSet = new Set(originalAnnotations.map(a => `${a.category}_${a.variable}_${a.text}`));
  
  // TP (True Positives): anotaciones en ambos sets
  let truePositives = 0;
  manualSet.forEach(item => {
    if (originalSet.has(item)) {
      truePositives++;
    }
  });
  
  // FP (False Positives): anotaciones en manual pero no en original
  let falsePositives = manualSet.size - truePositives;
  
  // FN (False Negatives): anotaciones en original pero no en manual
  let falseNegatives = originalSet.size - truePositives;
  
  // Calcular Precisión: TP / (TP + FP)
  const precision = truePositives + falsePositives > 0 
    ? (truePositives / (truePositives + falsePositives)) * 100 
    : 0;
  
  // Calcular Recall: TP / (TP + FN)
  const recall = truePositives + falseNegatives > 0 
    ? (truePositives / (truePositives + falseNegatives)) * 100 
    : 0;
  
  // F1 Score (armonic mean)
  const f1Score = precision + recall > 0 
    ? (2 * precision * recall) / (precision + recall) 
    : 0;
  
  document.getElementById('precision-score').textContent = Math.round(precision) + '%';
  document.getElementById('recall-score').textContent = Math.round(recall) + '%';
  document.getElementById('total-score').textContent = Math.round(f1Score) + '%';
}
</script>
{% endblock %}
