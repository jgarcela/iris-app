{% extends "challenge/challenge_base.html" %}

{% block title %}{{ _('Resultados del Análisis con IRIS') }} - {{ text_data.title }}{% endblock %}

{% block challenge_content %}
<div class="container-fluid py-4">
    <!-- Header de Resultados -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-1">
                        <i class="fas fa-robot me-2 text-primary"></i>
                        {{ _('Resultados del Análisis con IRIS') }}
                    </h2>
                    <p class="text-muted mb-0">
                        {{ text_data.title }}
                        {% if text_data.url %}
                        <a href="{{ text_data.url }}" target="_blank" rel="noopener" class="ms-2 small text-decoration-none">
                            <i class="fas fa-link me-1"></i>{{ _('Fuente') }}
                        </a>
                        {% endif %}
                    </p>
                </div>
                <div>
                    {% if next_text_id %}
                        <a href="{{ url_for('challenge.analyze_text', text_id=next_text_id) }}" class="btn btn-primary">
                            <i class="fas fa-arrow-right me-2"></i>
                            {{ _('Siguiente Texto') }}
                        </a>
                    {% else %}
                    <a href="{{ url_for('challenge.challenge_home') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-check me-2"></i>
                            {{ _('Finalizar') }}
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Métricas de Comparación -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="gamified-score-card">
                <div class="gamified-score-header">
                    <i class="fas fa-trophy me-2"></i>
                    <span class="gamified-score-title">{{ _('Puntuación Final') }}</span>
                </div>
                <div class="gamified-score-content">
                    <div class="gamified-score-display">
                        <div class="score-circle">
                            <div class="score-value-wrapper">
                                <span class="gamified-score-value" id="total-score">0%</span>
                                <div class="score-label-gamified">
                                    <i class="fas fa-star me-1"></i>{{ _('Puntuación Total') }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Desglose de Puntuación (Tabs) -->
    <div class="row mb-4" id="score-breakdown-section" style="display: none;">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <ul class="nav nav-tabs card-header-tabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <a class="nav-link active" id="score-overview-tab" data-bs-toggle="tab" href="#score-overview-pane" role="tab" aria-controls="score-overview-pane" aria-selected="true">
                                <i class="fas fa-chart-pie me-2"></i>{{ _('Resumen') }}
                            </a>
                        </li>
                        <li class="nav-item" role="presentation">
                            <a class="nav-link" id="score-table-tab" data-bs-toggle="tab" href="#score-table-pane" role="tab" aria-controls="score-table-pane" aria-selected="false">
                                <i class="fas fa-list-ol me-2"></i>{{ _('Desglose por anotación') }}
                            </a>
                        </li>
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content">
                        <!-- Overview pane -->
                        <div class="tab-pane fade show active" id="score-overview-pane" role="tabpanel" aria-labelledby="score-overview-tab">
                            <div class="row g-3">
                                <div class="col-lg-3 col-md-6">
                                    <div class="gamified-stat-card stat-exacto">
                                        <div class="stat-card-header">
                                            <div class="stat-icon-wrapper stat-icon-success">
                                                <i class="fas fa-check-circle"></i>
                                            </div>
                                        </div>
                                        <div class="stat-card-body">
                                            <div class="stat-value" id="breakdown-exactos">0</div>
                                            <div class="stat-label">{{ _('Exactos') }}</div>
                                            <div class="stat-points">
                                                <i class="fas fa-star me-1"></i>
                                                <span class="fw-bold">+100 pts c/u</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-3 col-md-6">
                                    <div class="gamified-stat-card stat-parcial">
                                        <div class="stat-card-header">
                                            <div class="stat-icon-wrapper stat-icon-info">
                                                <i class="fas fa-info-circle"></i>
                                            </div>
                                        </div>
                                        <div class="stat-card-body">
                                            <div class="stat-value" id="breakdown-parciales">0</div>
                                            <div class="stat-label">{{ _('Parciales') }}</div>
                                            <div class="stat-points">
                                                <i class="fas fa-star-half-alt me-1"></i>
                                                <span class="fw-bold">+50 pts c/u</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-3 col-md-6">
                                    <div class="gamified-stat-card stat-extra">
                                        <div class="stat-card-header">
                                            <div class="stat-icon-wrapper stat-icon-warning">
                                                <i class="fas fa-times-circle"></i>
                                            </div>
                                        </div>
                                        <div class="stat-card-body">
                                            <div class="stat-value" id="breakdown-extras">0</div>
                                            <div class="stat-label">{{ _('Extras') }}</div>
                                            <div class="stat-points stat-points-info">
                                                <i class="fas fa-info-circle me-1"></i>
                                                <span class="text-muted">Solo informativo</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-3 col-md-6">
                                    <div class="gamified-stat-card stat-faltante">
                                        <div class="stat-card-header">
                                            <div class="stat-icon-wrapper stat-icon-secondary">
                                                <i class="fas fa-minus-circle"></i>
                                            </div>
                                        </div>
                                        <div class="stat-card-body">
                                            <div class="stat-value" id="breakdown-faltantes">0</div>
                                            <div class="stat-label">{{ _('Faltantes') }}</div>
                                            <div class="stat-points stat-points-info">
                                                <i class="fas fa-info-circle me-1"></i>
                                                <span class="text-muted">Solo informativo</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Table pane -->
                        <div class="tab-pane fade" id="score-table-pane" role="tabpanel" aria-labelledby="score-table-tab">
                            <div class="table-responsive">
                                <table class="table table-sm align-middle mb-0" id="score-breakdown-table">
                                    <thead class="table-light">
                                        <tr>
                                            <th style="border-top: none;"><i class="fas fa-tags text-primary me-2"></i>{{ _('Categoría') }}</th>
                                            <th style="border-top: none;"><i class="fas fa-code text-primary me-2"></i>{{ _('Variable') }}</th>
                                            <th style="border-top: none;"><i class="fas fa-align-left text-primary me-2"></i>{{ _('Texto') }}</th>
                                            <th class="text-center" style="border-top: none;"><i class="fas fa-star text-primary me-2"></i>{{ _('Resultado') }}</th>
                                            <th class="text-end" style="border-top: none;"><i class="fas fa-coins text-primary me-2"></i>{{ _('Puntos') }}</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- filas generadas por JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Comparación de Análisis -->
    <div class="row">
        <!-- Análisis Manual -->
        <div class="col-lg-6 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header text-white" style="background-color: #5de0e6;">
                    <h5 class="mb-0">
                        <i class="fas fa-user-edit me-2"></i>
                        {{ _('Tu Análisis Manual') }}
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Tabs Navigation -->
                    <ul class="nav nav-tabs mb-3" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" id="manual-text-tab" data-bs-toggle="tab" href="#manual-text-content" role="tab">
                                <i class="fas fa-file-alt me-1"></i> {{ _('Texto') }}
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="manual-summary-tab" data-bs-toggle="tab" href="#manual-summary-content" role="tab">
                                <i class="fas fa-list me-1"></i> {{ _('Desglose de anotaciones') }}
                            </a>
                        </li>
                    </ul>
                    
                    <!-- Tab Content -->
                    <div class="tab-content">
                        <!-- Texto Tab -->
                        <div class="tab-pane fade show active" id="manual-text-content" role="tabpanel">
                            <div class="text-visualization">
                                <p><strong>{{ _('Texto con tus anotaciones:') }}</strong> <span id="manual-annotations-count" class="badge" style="background-color: #5de0e6;">0</span></p>
                                <div id="manual-text-highlights" class="highlighted-text" style="padding: 15px; border: 1px solid #dee2e6; border-radius: 5px; background: #f8f9fa;">
                                    <!-- Texto con highlights se carga aquí -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Resumen Tab -->
                        <div class="tab-pane fade" id="manual-summary-content" role="tabpanel">
                            <div id="manual-summary" class="annotations-summary">
                                <!-- Resumen por categorías se carga aquí -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Análisis de IA -->
        <div class="col-lg-6 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header text-white" style="background-color: #8e44ad;">
                    <h5 class="mb-0">
                        <i class="fas fa-clipboard-check me-2"></i>
                        {{ _('Anotaciones IRIS') }}
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Tabs Navigation -->
                    <ul class="nav nav-tabs mb-3" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" id="original-text-tab" data-bs-toggle="tab" href="#original-text-content" role="tab">
                                <i class="fas fa-file-alt me-1"></i> {{ _('Texto') }}
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="original-summary-tab" data-bs-toggle="tab" href="#original-summary-content" role="tab">
                                <i class="fas fa-list me-1"></i> {{ _('Desglose de anotaciones') }}
                            </a>
                        </li>
                    </ul>
                    
                    <!-- Tab Content -->
                    <div class="tab-content">
                        <!-- Texto Tab -->
                        <div class="tab-pane fade show active" id="original-text-content" role="tabpanel">
                            <div class="text-visualization">
                                <p><strong>{{ _('Texto con anotaciones IRIS:') }}</strong> <span id="original-annotations-count" class="badge" style="background-color: #8e44ad;">0</span></p>
                                <div id="original-text-highlights" class="highlighted-text" style="padding: 15px; border: 1px solid #dee2e6; border-radius: 5px; background: #f8f9fa;">
                                    <!-- Texto con highlights se carga aquí -->
                </div>
                            </div>
                        </div>
                        
                        <!-- Resumen Tab -->
                        <div class="tab-pane fade" id="original-summary-content" role="tabpanel">
                            <div id="original-summary" class="annotations-summary">
                                <!-- Resumen por categorías se carga aquí -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


</div>

<style>
.analysis-summary, .ai-summary {
    min-height: 200px;
}

.annotations-list {
    max-height: 300px;
    overflow-y: auto;
}

.annotation-item {
    background: #f8f9fa;
    padding: 0.75rem;
    border-radius: 6px;
    margin-bottom: 0.5rem;
    border-left: 4px solid #007bff;
}

.annotation-text {
    font-size: 0.9rem;
    color: #495057;
    margin-bottom: 0.25rem;
}

.annotation-meta {
    font-size: 0.8rem;
    color: #6c757d;
}

.metric-item {
    padding: 1rem;
}

.metric-value {
    font-size: 2.5rem;
    font-weight: bold;
    color: #495057;
    margin-bottom: 0.5rem;
}

.metric-label {
    color: #6c757d;
    font-weight: 600;
}

.score-highlight {
    color: #28a745 !important;
}

/* Compact Metrics Styles */
.metrics-compact {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 0.75rem 1rem;
}

.metrics-header {
    margin-bottom: 0.5rem;
}

.metrics-title {
    font-size: 0.9rem;
    font-weight: 600;
    color: #495057;
}

.metric-compact-item {
    text-align: center;
    padding: 0.5rem;
    background: white;
    border-radius: 6px;
    border: 1px solid #e9ecef;
}

.metric-compact-value {
    display: block;
    font-size: 1.5rem;
    font-weight: bold;
    color: #495057;
    margin-bottom: 0.25rem;
}

.metric-compact-label {
    font-size: 0.75rem;
    color: #6c757d;
    font-weight: 500;
}

.metric-compact-value.score-highlight {
    color: #28a745 !important;
}

.ai-category {
    margin-bottom: 1rem;
}

/* Styles for annotation highlights */
.highlighted-text {
    line-height: 1.8;
    font-size: 1rem;
    color: #495057;
    white-space: pre-wrap;
    word-wrap: break-word;
    text-align: justify;
}

.highlighted-text mark {
    padding: 2px 4px;
    border-radius: 3px;
    font-weight: 500;
    cursor: help;
    position: relative;
    transition: all 0.2s ease;
}

.highlighted-text mark:hover {
    filter: brightness(1.1);
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.mark-contenido_general {
    background-color: #d4edda;
    border-bottom: 3px solid #28a745;
}

.mark-contenido_general:hover {
    background-color: #b8dfc0;
}

.mark-lenguaje {
    background-color: #ffe6e6;
    border-bottom: 3px solid #dc3545;
}

.mark-lenguaje:hover {
    background-color: #ffd6d6;
}

.mark-fuentes {
    background-color: #e6f3ff;
    border-bottom: 3px solid #007bff;
}

.mark-fuentes:hover {
    background-color: #cce7ff;
}

/* Lightweight tooltip for annotations */
.annotation-tooltip {
    position: fixed;
    z-index: 2000;
    background: rgba(0,0,0,0.85);
    color: #fff;
    font-size: 12px;
    padding: 6px 8px;
    border-radius: 6px;
    pointer-events: none;
    max-width: 280px;
    line-height: 1.3;
    display: none;
}

.ai-category h6 {
    color: #495057;
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.ai-category ul {
    margin: 0;
    padding-left: 1.2rem;
}

.ai-category li {
    margin-bottom: 0.25rem;
    font-size: 0.9rem;
}

.text-content {
    line-height: 1.8;
    font-size: 1.1rem;
    color: #495057;
    white-space: pre-wrap;
    word-wrap: break-word;
    text-align: justify;
}

.action-buttons {
    margin-top: 2rem;
}

/* Tab Styles */
.nav-tabs .nav-link {
    color: #6c757d;
    border: none;
    border-bottom: 2px solid transparent;
    padding: 0.5rem 1rem;
}

.nav-tabs .nav-link:hover {
    border-color: transparent;
    color: #495057;
}

.nav-tabs .nav-link.active {
    color: #495057;
    border-bottom-color: #007bff;
    background-color: transparent;
}

/* Annotations Summary Styles */
.annotations-summary {
    padding: 1rem;
}

.summary-category {
    margin-bottom: 1.5rem;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 8px;
    border-left: 4px solid #ddd;
}

.summary-category.contenido_general {
    border-left-color: #28a745;
}

.summary-category.lenguaje {
    border-left-color: #dc3545;
}

.summary-category.fuentes {
    border-left-color: #007bff;
}

.summary-category h6 {
    font-weight: 600;
    margin-bottom: 0.75rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.summary-variables {
    list-style: none;
    padding: 0;
    margin: 0;
}

.summary-variables li {
    padding: 0.5rem;
    margin-bottom: 0.5rem;
    background: white;
    border-radius: 4px;
    border-left: 3px solid #dee2e6;
}

.summary-variables li strong {
    color: #495057;
    display: block;
    margin-bottom: 0.25rem;
}

.summary-variables li span {
    font-size: 0.875rem;
    color: #6c757d;
}

.annotation-count {
    font-size: 0.8rem;
    color: #6c757d;
    margin-left: 0.5rem;
    font-style: italic;
}

.summary-texts {
    margin-top: 0.5rem;
}

.summary-text-item {
    padding: 0.375rem 0.5rem;
    margin-bottom: 0.25rem;
    background: #e8f4fd;
    border-left: 2px solid #007bff;
    font-size: 0.85rem;
    color: #495057;
    font-style: italic;
    border-radius: 3px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.summary-text-item:hover {
    background: #d1ecf1;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.summary-text-item.expanded {
    background: #fff3cd;
    border-left-color: #ffc107;
}

.summary-text-item .expand-icon {
    float: right;
    font-size: 0.75rem;
    color: #6c757d;
    margin-left: 0.5rem;
}

/* Gamified Table Styles */
#score-breakdown-table {
    border-radius: 8px;
    overflow: hidden;
}

#score-breakdown-table thead th {
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.8rem;
    letter-spacing: 0.4px;
    padding: 0.5rem 0.5rem;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-bottom: 1px solid #dee2e6;
}

#score-breakdown-table tbody tr {
    border-bottom: 1px solid #f1f3f5;
    transition: all 0.2s ease;
}

#score-breakdown-table tbody tr:hover {
    background: linear-gradient(90deg, rgba(13, 110, 253, 0.05) 0%, rgba(13, 110, 253, 0.02) 100%);
    transform: translateX(2px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

#score-breakdown-table tbody td {
    padding: 0.5rem 0.5rem;
    vertical-align: middle;
    font-size: 0.95rem;
}

.gamified-row {
    animation: fadeInUp 0.3s ease-out;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Badge Styles */
#score-breakdown-table .badge {
    font-weight: 600;
    text-transform: uppercase;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    justify-content: center;
}

#score-breakdown-table .badge:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

#score-breakdown-table .badge.bg-success {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%) !important;
    border: none;
}

#score-breakdown-table .badge.bg-info {
    background: linear-gradient(135deg, #17a2b8 0%, #138496 100%) !important;
    border: none;
}

#score-breakdown-table .badge.bg-secondary {
    background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%) !important;
    border: none;
}

/* Points Display */
#score-breakdown-table td:last-child {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    font-weight: 700;
}

#score-breakdown-table .text-success {
    color: #198754 !important;
    text-shadow: 0 1px 2px rgba(25, 135, 84, 0.2);
}

#score-breakdown-table .text-info {
    color: #0dcaf0 !important;
    text-shadow: 0 1px 2px rgba(13, 202, 240, 0.2);
}

/* Category and Variable Badges */
#score-breakdown-table .badge.bg-primary.bg-opacity-10 {
    font-weight: 500;
    transition: all 0.2s ease;
}

#score-breakdown-table .badge.bg-primary.bg-opacity-10:hover {
    background: rgba(13, 110, 253, 0.2) !important;
    transform: translateY(-1px);
}

#score-breakdown-table code {
    background: rgba(13, 110, 253, 0.08);
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.9rem;
    border: 1px solid rgba(13, 110, 253, 0.15);
}

/* Gamified Score Card Styles */
.gamified-score-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 12px;
    padding: 1rem 1.25rem;
    box-shadow: 0 4px 14px rgba(102, 126, 234, 0.25);
    position: relative;
    overflow: hidden;
}

.gamified-score-card::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
    animation: pulse 3s ease-in-out infinite;
}

@keyframes slideInDown {
    from {
        opacity: 0;
        transform: translateY(-30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes pulse {
    0%, 100% {
        transform: scale(1);
        opacity: 0.5;
    }
    50% {
        transform: scale(1.1);
        opacity: 0.8;
    }
}

.gamified-score-header {
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 0.5rem;
    color: white;
    font-size: 1rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.gamified-score-header i {
    font-size: 1.5rem;
    animation: rotate 2s ease-in-out infinite;
}

@keyframes rotate {
    0%, 100% {
        transform: rotate(0deg);
    }
    25% {
        transform: rotate(-10deg);
    }
    75% {
        transform: rotate(10deg);
    }
}

.gamified-score-content {
    display: flex;
    justify-content: center;
    align-items: center;
}

.score-circle {
    position: relative;
    width: 140px;
    height: 140px;
    background: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 6px 18px rgba(0, 0, 0, 0.12);
}

@keyframes scaleIn {
    from {
        transform: scale(0);
        opacity: 0;
    }
    to {
        transform: scale(1);
        opacity: 1;
    }
}

.score-value-wrapper {
    text-align: center;
    z-index: 1;
}

.gamified-score-value {
    display: block;
    font-size: 2.75rem;
    font-weight: 800;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    line-height: 1;
    margin-bottom: 0.25rem;
}

@keyframes countUp {
    from {
        transform: scale(0.5);
        opacity: 0;
    }
    to {
        transform: scale(1);
        opacity: 1;
    }
}

.score-label-gamified {
    font-size: 0.8rem;
    color: #6c757d;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.4px;
}

.score-label-gamified i {
    color: #ffc107;
}

/* Gamified Stat Cards */
.gamified-stat-card {
    background: white;
    border-radius: 10px;
    padding: 1rem;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
    transition: all 0.2s ease;
    position: relative;
    overflow: hidden;
}

.gamified-stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, transparent, currentColor, transparent);
    opacity: 0;
    transition: opacity 0.3s ease;
}

.gamified-stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
}

.gamified-stat-card:hover::before {
    opacity: 1;
}

.stat-exacto {
    border-top: 4px solid #28a745;
}

.stat-exacto:hover {
    box-shadow: 0 8px 25px rgba(40, 167, 69, 0.25);
}

.stat-exacto::before {
    background: linear-gradient(90deg, transparent, #28a745, transparent);
}

.stat-parcial {
    border-top: 4px solid #17a2b8;
}

.stat-parcial:hover {
    box-shadow: 0 8px 25px rgba(23, 162, 184, 0.25);
}

.stat-parcial::before {
    background: linear-gradient(90deg, transparent, #17a2b8, transparent);
}

.stat-extra {
    border-top: 4px solid #ffc107;
}

.stat-extra:hover {
    box-shadow: 0 8px 25px rgba(255, 193, 7, 0.25);
}

.stat-extra::before {
    background: linear-gradient(90deg, transparent, #ffc107, transparent);
}

.stat-faltante {
    border-top: 4px solid #6c757d;
}

.stat-faltante:hover {
    box-shadow: 0 8px 25px rgba(108, 117, 125, 0.25);
}

.stat-faltante::before {
    background: linear-gradient(90deg, transparent, #6c757d, transparent);
}

.stat-card-header {
    display: flex;
    justify-content: center;
    margin-bottom: 0.5rem;
}

.stat-icon-wrapper {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
    transition: all 0.2s ease;
}

.gamified-stat-card:hover .stat-icon-wrapper {
    transform: scale(1.1) rotate(5deg);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
}

.stat-icon-success {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    color: white;
}

.stat-icon-info {
    background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
    color: white;
}

.stat-icon-warning {
    background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
    color: white;
}

.stat-icon-secondary {
    background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
    color: white;
}

.stat-card-body {
    text-align: center;
}

.stat-value {
    font-size: 2rem;
    font-weight: 800;
    line-height: 1;
    margin-bottom: 0.25rem;
}

.stat-exacto .stat-value {
    color: #28a745;
}

.stat-parcial .stat-value {
    color: #17a2b8;
}

.stat-extra .stat-value {
    color: #ffc107;
}

.stat-faltante .stat-value {
    color: #6c757d;
}

.stat-label {
    font-size: 0.85rem;
    font-weight: 600;
    color: #495057;
    text-transform: uppercase;
    letter-spacing: 0.4px;
    margin-bottom: 0.5rem;
}

.stat-points {
    font-size: 0.85rem;
    padding: 0.25rem 0.75rem;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 16px;
    display: inline-block;
}

.stat-exacto .stat-points {
    color: #28a745;
}

.stat-exacto .stat-points i {
    color: #ffc107;
}

.stat-parcial .stat-points {
    color: #17a2b8;
}

.stat-parcial .stat-points i {
    color: #ffc107;
}

.stat-points-info {
    color: #6c757d !important;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%) !important;
}

.stat-points-info i {
    color: #6c757d !important;
}

.gamified-stat-card:hover .stat-points {
    transform: scale(1.05);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}
</style>

<script>
// Datos desde el backend
const manualAnnotations = {{ manual_annotations | tojson | safe }};
const originalAnnotations = {{ original_annotations | tojson | safe }};
const gamifiedReport = {{ gamified_report | tojson | safe if gamified_report else 'null' }};

// Variable descriptions for tooltips
const VARIABLE_DESCRIPTIONS = {
  'cita_textual_titular': 'Cita textual titular',
  'genero_nombre_propio_titular': 'Género nombre propio titular',
  'genero_periodista': 'Género periodista',
  'genero_personas_mencionadas': 'Género personas mencionadas',
  'nombre_propio_titular': 'Nombre propio titular',
  'personas_mencionadas': 'Personas mencionadas',
  'tema': 'Tema',
  'androcentrismo': 'Androcentrismo',
  'asimetria': 'Asimetría',
  'cargos_mujeres': 'Cargos mujeres',
  'comparacion_mujeres_hombres': 'Comparación mujeres/hombres',
  'denominacion_dependiente': 'Denominación dependiente',
  'denominacion_redundante': 'Denominación redundante',
  'denominacion_sexualizada': 'Denominación sexualizada',
  'dual_aparente': 'Dual aparente',
  'excepcion_noticiabilidad': 'Excepción noticiabilidad',
  'hombre_humanidad': 'Hombre humanidad',
  'infantilizacion': 'Infantilización',
  'lenguaje_sexista': 'Lenguaje sexista',
  'masculino_generico': 'Masculino genérico',
  'sexismo_social': 'Sexismo social',
  'declaracion_fuente': 'Declaración fuente',
  'genero_fuente': 'Género fuente',
  'nombre_fuente': 'Nombre fuente',
  'tipo_fuente': 'Tipo fuente'
};

document.addEventListener('DOMContentLoaded', function() {
  loadAnalysisResults();
});

function loadAnalysisResults() {
  loadManualAnnotations();
  loadManualSummary();
  loadOriginalAnnotations();
  loadOriginalSummary();
  calculateMetrics();
  initMultiLabelTooltips();
  synchronizeTabs();
  setupTextExpansion();
}

function setupTextExpansion() {
  // Add event listeners to all summary text items
  document.addEventListener('click', function(e) {
    const textItem = e.target.closest('.summary-text-item');
    if (!textItem) return;
    
    const fullText = textItem.getAttribute('data-full-text');
    const textContent = textItem.querySelector('.text-content');
    const expandIcon = textItem.querySelector('.expand-icon');
    
    if (!fullText || !textContent) return;
    
    const isExpanded = textItem.classList.contains('expanded');
    
    if (isExpanded) {
      // Collapse
      const truncatedText = fullText.length > 80 ? fullText.substring(0, 80) + '...' : fullText;
      textContent.textContent = truncatedText;
      textItem.classList.remove('expanded');
      if (expandIcon) {
        expandIcon.className = 'fas fa-expand-alt expand-icon';
        expandIcon.title = 'Ver texto completo';
      }
    } else {
      // Expand
      textContent.textContent = fullText;
      textItem.classList.add('expanded');
      if (expandIcon) {
        expandIcon.className = 'fas fa-compress-alt expand-icon';
        expandIcon.title = 'Contraer texto';
      }
    }
  });
}

function synchronizeTabs() {
  let isSyncing = false; // Flag to prevent infinite loop

  // Get all tab links
  const manualTextTab = document.getElementById('manual-text-tab');
  const manualSummaryTab = document.getElementById('manual-summary-tab');
  const originalTextTab = document.getElementById('original-text-tab');
  const originalSummaryTab = document.getElementById('original-summary-tab');

  // Manual tabs event listeners
  manualTextTab.addEventListener('shown.bs.tab', function() {
    if (!isSyncing) {
      isSyncing = true;
      originalTextTab.click();
      setTimeout(() => { isSyncing = false; }, 100);
    }
  });

  manualSummaryTab.addEventListener('shown.bs.tab', function() {
    if (!isSyncing) {
      isSyncing = true;
      originalSummaryTab.click();
      setTimeout(() => { isSyncing = false; }, 100);
    }
  });

  // Original tabs event listeners
  originalTextTab.addEventListener('shown.bs.tab', function() {
    if (!isSyncing) {
      isSyncing = true;
      manualTextTab.click();
      setTimeout(() => { isSyncing = false; }, 100);
    }
  });

  originalSummaryTab.addEventListener('shown.bs.tab', function() {
    if (!isSyncing) {
      isSyncing = true;
      manualSummaryTab.click();
      setTimeout(() => { isSyncing = false; }, 100);
    }
  });
}

function initMultiLabelTooltips() {
  let tooltip = null;
  const ensureTooltip = () => {
    if (!tooltip) {
      tooltip = document.createElement('div');
      tooltip.className = 'annotation-tooltip';
      document.body.appendChild(tooltip);
    }
    return tooltip;
  };

  document.addEventListener('mousemove', function(e) {
    const tip = ensureTooltip();
    const underPointer = (document.elementsFromPoint ? document.elementsFromPoint(e.clientX, e.clientY) : []);
    const marks = underPointer.filter(el => el && el.classList && el.classList.contains('annotation-mark'));
    if (!marks || marks.length === 0) { tip.style.display = 'none'; return; }

    const variables = Array.from(new Set(marks.map(m => m.getAttribute('data-variable')).filter(Boolean)));
    const categories = Array.from(new Set(marks.map(m => {
      if (m.classList.contains('mark-contenido_general')) return 'Contenido General';
      if (m.classList.contains('mark-lenguaje')) return 'Lenguaje';
      if (m.classList.contains('mark-fuentes')) return 'Fuentes';
      return '';
    }).filter(Boolean)));
    const varLabel = variables.map(v => VARIABLE_DESCRIPTIONS[v] || (v || '').replace(/_/g,' ')).join(' + ');
    const catLabel = categories.join(', ');
    tip.textContent = catLabel ? `${catLabel} · ${varLabel}` : varLabel;
    tip.style.left = (e.clientX + 12) + 'px';
    tip.style.top = (e.clientY + 12) + 'px';
    tip.style.display = 'block';
  });

  document.addEventListener('scroll', function() { if (tooltip) tooltip.style.display = 'none'; }, true);
  document.addEventListener('mouseleave', function() { if (tooltip) tooltip.style.display = 'none'; });
}

function loadOriginalAnnotations() {
  const container = document.getElementById('original-text-highlights');
  const countElement = document.getElementById('original-annotations-count');
  
  if (!originalAnnotations || originalAnnotations.length === 0) {
    container.innerHTML = '<p class="text-muted text-center py-3"><i class="fas fa-info-circle me-2"></i>{{ _("No hay anotaciones originales disponibles") }}</p>';
    countElement.textContent = '0';
    return;
  }
  
  countElement.textContent = originalAnnotations.length;
  
  // Get the original text
  const originalText = {{ text_data.text | tojson | safe }};
  
  // Apply highlights to text
  let highlightedText = applyAnnotationsToText(originalText, originalAnnotations);
  container.innerHTML = highlightedText;
}

function loadManualAnnotations() {
  const container = document.getElementById('manual-text-highlights');
  const countElement = document.getElementById('manual-annotations-count');
  countElement.textContent = manualAnnotations.length;
  
  if (manualAnnotations.length === 0) {
    container.innerHTML = '<p class="text-muted text-center py-3"><i class="fas fa-info-circle me-2"></i>{{ _("No se realizaron anotaciones manuales") }}</p>';
    return;
  }
  
  // Get the original text
  const originalText = {{ text_data.text | tojson | safe }};
  
 // Apply highlights to text
  let highlightedText = applyAnnotationsToText(originalText, manualAnnotations);
  container.innerHTML = highlightedText;
}

function loadManualSummary() {
  const container = document.getElementById('manual-summary');
  generateSummaryHTML(manualAnnotations, container);
}

function loadOriginalSummary() {
  const container = document.getElementById('original-summary');
  generateSummaryHTML(originalAnnotations, container);
}

function generateSummaryHTML(annotations, container) {
  if (!annotations || annotations.length === 0) {
    container.innerHTML = '<p class="text-muted text-center py-3"><i class="fas fa-info-circle me-2"></i>{{ _("No hay anotaciones para mostrar") }}</p>';
    return;
  }

  // Group by category and variable
  const grouped = {};
  annotations.forEach(ann => {
    const cat = ann.category || 'other';
    if (!grouped[cat]) {
      grouped[cat] = {};
    }
    const varName = ann.variable || 'unknown';
    if (!grouped[cat][varName]) {
      grouped[cat][varName] = {
        texts: new Set(),
        count: 0
      };
    }
    grouped[cat][varName].texts.add(ann.text);
    grouped[cat][varName].count++;
  });

  // Generate HTML
  let html = '';
  Object.entries(grouped).forEach(([category, variables]) => {
    const categoryName = category === 'contenido_general' ? 'Contenido General' :
                        category === 'lenguaje' ? 'Lenguaje' :
                        category === 'fuentes' ? 'Fuentes' : category;
    
    html += `<div class="summary-category ${category}">`;
    html += `<h6>${categoryName}</h6>`;
    html += '<ul class="summary-variables">';
    
    Object.entries(variables).forEach(([variable, data]) => {
      const varDesc = VARIABLE_DESCRIPTIONS[variable] || variable.replace(/_/g, ' ');
      const textsArray = Array.from(data.texts);
      html += '<li>';
      html += `<strong>${varDesc}</strong>`;
      html += `<span class="annotation-count">${data.count} ${data.count > 1 ? 'anotaciones' : 'anotación'}</span>`;
      if (textsArray.length > 0) {
        html += '<div class="summary-texts mt-2">';
        textsArray.forEach(text => {
          const truncatedText = text.length > 80 ? text.substring(0, 80) + '...' : text;
          const isTruncated = text.length > 80;
          const textId = `text-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
          html += `<div class="summary-text-item" data-full-text="${escapeHtml(text)}" data-text-id="${textId}">`;
          html += `<i class="fas fa-quote-left me-1"></i>`;
          html += `<span class="text-content">${escapeHtml(truncatedText)}</span>`;
          if (isTruncated) {
            html += `<i class="fas fa-expand-alt expand-icon" title="Ver texto completo"></i>`;
          }
          html += '</div>';
        });
        html += '</div>';
      }
      html += '</li>';
    });
    
    html += '</ul></div>';
  });

  container.innerHTML = html;
}

function applyAnnotationsToText(text, annotations) {
  if (!annotations || annotations.length === 0) return escapeHtml(text);
  
  // Group annotations by their text and category to avoid duplicates
  const annotationMap = new Map();
  annotations.forEach(annotation => {
    const key = `${annotation.text}|${annotation.category}`;
    if (!annotationMap.has(key)) {
      annotationMap.set(key, []);
    }
    annotationMap.get(key).push(annotation);
  });
  
  // Create sorted ranges (go backwards to avoid position shifting)
  const ranges = [];
  annotationMap.forEach((annotationList, key) => {
    const searchText = annotationList[0].text;
    let pos = text.indexOf(searchText);
    
    while (pos !== -1) {
      const category = annotationList[0].category;
      const variables = [...new Set(annotationList.map(a => a.variable))];
      const varDescriptions = variables.map(v => VARIABLE_DESCRIPTIONS[v] || v.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()));
      
      ranges.push({
        start: pos,
        end: pos + searchText.length,
        category: category,
        variables: variables.join(', '),
        varDescriptions: varDescriptions.join(', '),
        text: searchText
      });
      
      pos = text.indexOf(searchText, pos + searchText.length);
    }
  });
  
  // Sort from end to beginning
  ranges.sort((a, b) => b.start - a.start);
  
  let result = escapeHtml(text);
  ranges.forEach(range => {
    let searchEscaped = escapeHtml(range.text);
    let searchPos = result.indexOf(searchEscaped, 0);
    if (searchPos !== -1) {
      const before = result.substring(0, searchPos);
      const highlighted = `<mark class="annotation-mark mark-${range.category}" data-variable="${escapeHtml(range.variables)}">${searchEscaped}</mark>`;
      const after = result.substring(searchPos + searchEscaped.length);
      result = before + highlighted + after;
    }
  });
  
  return result;
}

function escapeHtml(text) {
  const map = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#039;'
  };
  return text.replace(/[&<>"']/g, m => map[m]);
}

function loadAIAnalysis() {
  const container = document.getElementById('ai-analysis-details');
  const countElement = document.getElementById('ai-variables-count');

  // Render según dificultad
  if (currentDifficulty === 'easy' && Array.isArray(aiAnalysis.sesgos)) {
    countElement.textContent = aiAnalysis.sesgos.length;
    container.innerHTML = `
      <div class="ai-category">
        <h6>{{ _("Sesgos detectados") }}</h6>
        <ul>
          ${aiAnalysis.sesgos.map(s => `<li>${s}</li>`).join('')}
        </ul>
      </div>
    `;
    return;
  }

  // Medium / Hard (categorías)
  let totalVariables = 0;
  const cg = aiAnalysis.contenido_general || {};
  const lg = aiAnalysis.lenguaje || {};
  const ft = aiAnalysis.fuentes || {};

  // Contador básico (número de campos con valor no vacío)
  [cg, lg, ft].forEach(group => {
    if (!group) return;
    Object.values(group).forEach(v => { if (v && (Array.isArray(v) ? v.length : String(v).length)) totalVariables++; });
  });
  countElement.textContent = totalVariables;

  container.innerHTML = `
    <div class="ai-category">
      <h6>{{ _("Contenido General") }}</h6>
      <ul>
        <li>{{ _("Personas mencionadas:") }} ${cg.personas_mencionadas ?? 'N/A'}</li>
        <li>{{ _("Género periodista:") }} ${cg.genero_periodista ?? 'N/A'}</li>
        <li>{{ _("Tema:") }} ${cg.tema ?? 'N/A'}</li>
      </ul>
    </div>
    <div class="ai-category">
      <h6>{{ _("Lenguaje") }}</h6>
      <ul>
        <li>{{ _("Lenguaje sexista:") }} ${lg.lenguaje_sexista ?? 'N/A'}</li>
        <li>{{ _("Androcentrismo:") }} ${lg.androcentrismo ?? 'N/A'}</li>
        <li>{{ _("Asimetría:") }} ${lg.asimetria ?? 'N/A'}</li>
        <li>{{ _("Infantilización:") }} ${lg.infantilizacion ?? 'N/A'}</li>
        <li>{{ _("Masculino genérico:") }} ${lg.masculino_generico ?? 'N/A'}</li>
      </ul>
    </div>
    <div class="ai-category">
      <h6>{{ _("Fuentes") }}</h6>
      <ul>
        <li>{{ _("Nombre fuente:") }} ${ft.nombre_fuente ?? 'N/A'}</li>
        <li>{{ _("Género fuente:") }} ${ft.genero_fuente ?? 'N/A'}</li>
        <li>{{ _("Tipo fuente:") }} ${ft.tipo_fuente ?? 'N/A'}</li>
      </ul>
    </div>
  `;
}

// Función para animar valores numéricos
function animateValue(elementId, start, end, duration, suffix = '') {
  const element = document.getElementById(elementId);
  if (!element) return;
  
  const startTime = performance.now();
  const range = end - start;
  
  function update(currentTime) {
    const elapsed = currentTime - startTime;
    const progress = Math.min(elapsed / duration, 1);
    
    // Easing function (ease-out)
    const easeProgress = 1 - Math.pow(1 - progress, 3);
    const current = Math.round(start + range * easeProgress);
    
    element.textContent = current + suffix;
    
    if (progress < 1) {
      requestAnimationFrame(update);
    } else {
      element.textContent = end + suffix;
    }
  }
  
  requestAnimationFrame(update);
}

function calculateMetrics() {
  // Usar score gamificado si está disponible
  if (gamifiedReport && gamifiedReport.resumen_global) {
    const resumen = gamifiedReport.resumen_global;
    const exactos = resumen.exactos || 0;
    const parciales = resumen.parciales || 0;
    const extras = resumen.extras || 0;
    const faltantes = resumen.faltantes || 0;
    const puntosTotales = resumen.puntos_totales || 0;
    const scoreFinal = resumen.score_final || 0;
    
    // Mostrar solo score final con animación
    animateValue('total-score', 0, Math.round(scoreFinal), 1000, '%');
    
    // Mostrar desglose con animación
    animateValue('breakdown-exactos', 0, exactos, 800);
    animateValue('breakdown-parciales', 0, parciales, 800);
    animateValue('breakdown-extras', 0, extras, 800);
    animateValue('breakdown-faltantes', 0, faltantes, 800);
    
    // Mostrar sección de desglose
    document.getElementById('score-breakdown-section').style.display = 'block';
    
    console.log('[GAMIFIED_SCORE] Exactos:', exactos, 'Parciales:', parciales, 'Puntos:', puntosTotales, 'Score:', scoreFinal);
    // Construir tabla por anotación
    buildScoreBreakdownTable();
  } else {
    // Fallback: Comparación exacta (sistema anterior)
    const originalCount = originalAnnotations ? originalAnnotations.length : 0;
    
    if (originalCount === 0) {
      document.getElementById('total-score').textContent = 'N/A';
      return;
    }
    
    // Crear sets de identificadores únicos para comparar
    const manualSet = new Set(manualAnnotations.map(a => `${a.category}_${a.variable}_${a.text}`));
    const originalSet = new Set(originalAnnotations.map(a => `${a.category}_${a.variable}_${a.text}`));
    
    // TP (True Positives): anotaciones en ambos sets
    let truePositives = 0;
    manualSet.forEach(item => {
      if (originalSet.has(item)) {
        truePositives++;
      }
    });
    
    // FP (False Positives): anotaciones en manual pero no en original
    let falsePositives = manualSet.size - truePositives;
    
    // FN (False Negatives): anotaciones en original pero no en manual
    let falseNegatives = originalSet.size - truePositives;
    
    // F1 Score (armonic mean)
    const precision = truePositives + falsePositives > 0 
      ? (truePositives / (truePositives + falsePositives)) * 100 
      : 0;
    const recall = truePositives + falseNegatives > 0 
      ? (truePositives / (truePositives + falseNegatives)) * 100 
      : 0;
    const f1Score = precision + recall > 0 
      ? (2 * precision * recall) / (precision + recall) 
      : 0;
    
    document.getElementById('total-score').textContent = Math.round(f1Score) + '%';
    
    // Ocultar desglose si no hay reporte gamificado
    document.getElementById('score-breakdown-section').style.display = 'none';
  }
}

// Construye el desglose por anotación con puntos
function buildScoreBreakdownTable() {
  const tbody = document.querySelector('#score-breakdown-table tbody');
  if (!tbody) return;
  tbody.innerHTML = '';

  // Crear mapas por categoría/variable para matching exacto
  const toKey = s => (s || '').toString().trim().toLowerCase();
  const originalMap = new Map(); // cat -> var -> Set(text)
  originalAnnotations.forEach(a => {
    const c = a.category, v = a.variable, t = toKey(a.text);
    if (!c || !v || !t) return;
    if (!originalMap.has(c)) originalMap.set(c, new Map());
    if (!originalMap.get(c).has(v)) originalMap.get(c).set(v, new Set());
    originalMap.get(c).get(v).add(t);
  });

  const manualMap = new Map(); // cat -> var -> Set(text)
  manualAnnotations.forEach(a => {
    const c = a.category, v = a.variable, t = toKey(a.text);
    if (!c || !v || !t) return;
    if (!manualMap.has(c)) manualMap.set(c, new Map());
    if (!manualMap.get(c).has(v)) manualMap.get(c).set(v, new Set());
    manualMap.get(c).get(v).add(t);
  });

  // 1) Filas para cada anotación del usuario
  let rowIndex = 0;
  manualAnnotations.forEach(a => {
    const c = a.category, v = a.variable, tRaw = a.text, t = toKey(a.text);
    if (!c || !v || !t) return;

    const varsInCat = originalMap.get(c) || new Map();
    const exactSet = (varsInCat.get(v) || new Set());
    let tipo = 'extra';
    let puntos = 0;
    let icono = '';
    let badgeClass = '';
    let puntosClass = '';
    let puntosIcon = '';

    if (exactSet.has(t)) {
      tipo = 'exacto';
      puntos = 100;
      icono = '<i class="fas fa-check-circle me-1"></i>';
      badgeClass = 'bg-success bg-gradient';
      puntosClass = 'text-success';
      puntosIcon = '<i class="fas fa-star me-1"></i>';
    } else {
      // ¿parcial? buscar en otra variable de la misma categoría
      let encontradoParcial = false;
      for (const [ov, setTexts] of varsInCat.entries()) {
        if (ov === v) continue;
        if (setTexts.has(t)) {
          tipo = 'parcial';
          puntos = 50;
          encontradoParcial = true;
          icono = '<i class="fas fa-info-circle me-1"></i>';
          badgeClass = 'bg-info bg-gradient';
          puntosClass = 'text-info';
          puntosIcon = '<i class="fas fa-star-half-alt me-1"></i>';
          break;
        }
      }
      // Si no encontró parcial, es extra (0 puntos, sin penalización)
      if (!encontradoParcial) {
        tipo = 'extra';
        puntos = 0;
        icono = '<i class="fas fa-times-circle me-1"></i>';
        badgeClass = 'bg-secondary bg-gradient';
        puntosClass = 'text-muted';
        puntosIcon = '';
      }
    }

    const tr = document.createElement('tr');
    tr.style.opacity = '0';
    tr.style.transform = 'translateY(-10px)';
    tr.style.transition = 'all 0.3s ease';
    tr.className = 'gamified-row';
    tr.innerHTML = `
      <td class="align-middle">
        <span class="badge bg-primary bg-opacity-10 text-primary px-2 py-1">${escapeHtml(c)}</span>
      </td>
      <td class="align-middle">
        <code class="text-dark">${escapeHtml(v)}</code>
      </td>
      <td class="align-middle">
        <span class="text-dark">${escapeHtml(tRaw)}</span>
      </td>
      <td class="text-center align-middle">
        <span class="badge ${badgeClass} px-3 py-2 shadow-sm" style="font-size: 0.9rem; letter-spacing: 0.5px;">
          ${icono}${tipo}
        </span>
      </td>
      <td class="text-end align-middle">
        <span class="fw-bold ${puntosClass}" style="font-size: 1.1rem;">
          ${puntosIcon}${puntos}
        </span>
      </td>
    `;
    tbody.appendChild(tr);
    
    // Animación de entrada
    setTimeout(() => {
      tr.style.opacity = '1';
      tr.style.transform = 'translateY(0)';
    }, rowIndex * 30);
    rowIndex++;
  });

  // 2) Faltantes: en IRIS y no en usuario, por misma variable
  originalAnnotations.forEach(a => {
    const c = a.category, v = a.variable, tRaw = a.text, t = toKey(a.text);
    if (!c || !v || !t) return;
    const userSet = ((manualMap.get(c) || new Map()).get(v) || new Set());
    if (!userSet.has(t)) {
      const tr = document.createElement('tr');
      tr.style.opacity = '0';
      tr.style.transform = 'translateY(-10px)';
      tr.style.transition = 'all 0.3s ease';
      tr.className = 'gamified-row';
      tr.innerHTML = `
        <td class="align-middle">
          <span class="badge bg-primary bg-opacity-10 text-primary px-2 py-1">${escapeHtml(c)}</span>
        </td>
        <td class="align-middle">
          <code class="text-dark">${escapeHtml(v)}</code>
        </td>
        <td class="align-middle">
          <span class="text-muted">${escapeHtml(tRaw)}</span>
        </td>
        <td class="text-center align-middle">
          <span class="badge bg-secondary bg-gradient px-3 py-2 shadow-sm" style="font-size: 0.9rem; letter-spacing: 0.5px;">
            <i class="fas fa-minus-circle me-1"></i>faltante
          </span>
        </td>
        <td class="text-end align-middle">
          <span class="fw-bold text-muted" style="font-size: 1.1rem;">0</span>
        </td>
      `;
      tbody.appendChild(tr);
      
      // Animación de entrada
      setTimeout(() => {
        tr.style.opacity = '1';
        tr.style.transform = 'translateY(0)';
      }, rowIndex * 30);
      rowIndex++;
    }
  });
}
</script>
{% endblock %}
