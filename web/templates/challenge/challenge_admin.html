{% extends "challenge/challenge_base.html" %}

{% block title %}{{ _('Administración del Desafío') }} - IRIS{% endblock %}

{% block challenge_content %}
<div class="container-fluid py-4">
    <!-- Header de Administración -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-1">
                        <i class="fas fa-cogs me-2 text-primary"></i>
                        {{ _('Administración del Desafío') }}
                    </h2>
                    <p class="text-muted mb-0">
                        {{ _('Gestión de participantes - Semana de la Ciencia 2025') }}
                    </p>
                </div>
                <div>
                    <a href="{{ url_for('challenge.challenge_home') }}" class="btn btn-outline-primary">
                        <i class="fas fa-arrow-left me-2"></i>
                        {{ _('Volver al Desafío') }}
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Estadísticas Generales -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <i class="fas fa-users fa-2x text-primary mb-2"></i>
                    <h4 class="mb-1" id="total-participants">0</h4>
                    <p class="text-muted mb-0">{{ _('Participantes') }}</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <i class="fas fa-file-alt fa-2x text-success mb-2"></i>
                    <h4 class="mb-1" id="total-analyses">0</h4>
                    <p class="text-muted mb-0">{{ _('Análisis Realizados') }}</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <i class="fas fa-chart-line fa-2x text-warning mb-2"></i>
                    <h4 class="mb-1" id="avg-score">0%</h4>
                    <p class="text-muted mb-0">{{ _('Puntuación Promedio') }}</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <i class="fas fa-trophy fa-2x text-danger mb-2"></i>
                    <h4 class="mb-1" id="best-score">0%</h4>
                    <p class="text-muted mb-0">{{ _('Mejor Puntuación') }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Gestión de Usuarios -->
    <div class="row">
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-user-friends me-2"></i>
                        {{ _('Participantes del Desafío') }}
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>{{ _('Participante') }}</th>
                                    <th class="text-center">{{ _('Puntuación') }}</th>
                                    <th class="text-center">{{ _('Análisis') }}</th>
                                    <th class="text-center">{{ _('Última Actividad') }}</th>
                                    <th class="text-center">{{ _('Acciones') }}</th>
                                </tr>
                            </thead>
                            <tbody id="participants-table">
                                <!-- Datos de participantes se cargan aquí -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <!-- Asignar Rol de Desafío -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-success text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-user-plus me-2"></i>
                        {{ _('Asignar Participante') }}
                    </h6>
                </div>
                <div class="card-body">
                    <form id="assign-role-form">
                        <div class="mb-3">
                            <label for="user-email" class="form-label">{{ _('Email del Usuario') }}</label>
                            <input type="email" class="form-control" id="user-email" 
                                   placeholder="usuario@ejemplo.com" required>
                        </div>
                        <button type="submit" class="btn btn-success w-100">
                            <i class="fas fa-plus me-2"></i>
                            {{ _('Asignar Rol de Desafío') }}
                        </button>
                    </form>
                </div>
            </div>

            <!-- Configuración del Desafío -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-cog me-2"></i>
                        {{ _('Configuración') }}
                    </h6>
                </div>
                <div class="card-body">
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="challenge-active" checked>
                        <label class="form-check-label" for="challenge-active">
                            {{ _('Desafío Activo') }}
                        </label>
                    </div>
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="new-registrations" checked>
                        <label class="form-check-label" for="new-registrations">
                            {{ _('Permitir Nuevas Inscripciones') }}
                        </label>
                    </div>
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="show-results" checked>
                        <label class="form-check-label" for="show-results">
                            {{ _('Mostrar Resultados Públicos') }}
                        </label>
                    </div>
                    <button class="btn btn-outline-primary w-100" id="save-config-btn">
                        <i class="fas fa-save me-2"></i>
                        {{ _('Guardar Configuración') }}
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Exportar Datos -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card border-0 bg-light">
                <div class="card-body text-center">
                    <h5 class="mb-3">{{ _('Exportar Datos del Desafío') }}</h5>
                    <div class="btn-group" role="group">
                        <button class="btn btn-outline-primary" id="export-participants-btn">
                            <i class="fas fa-users me-2"></i>
                            {{ _('Participantes') }}
                        </button>
                        <button class="btn btn-outline-success" id="export-results-btn">
                            <i class="fas fa-chart-bar me-2"></i>
                            {{ _('Resultados') }}
                        </button>
                        <button class="btn btn-outline-warning" id="export-analyses-btn">
                            <i class="fas fa-file-alt me-2"></i>
                            {{ _('Análisis') }}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.card {
    transition: transform 0.2s ease;
}

.card:hover {
    transform: translateY(-2px);
}

.table th {
    border-top: none;
    font-weight: 600;
    color: #495057;
}

.participant-score {
    font-weight: 600;
}

.score-high {
    color: #28a745;
}

.score-medium {
    color: #ffc107;
}

.score-low {
    color: #dc3545;
}

.form-check-input:checked {
    background-color: #007bff;
    border-color: #007bff;
}

.btn-group .btn {
    margin-right: 0.5rem;
}

.btn-group .btn:last-child {
    margin-right: 0;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    loadParticipants();
    loadStatistics();
    setupEventListeners();
});

function loadParticipants() {
    fetch('/challenge/admin/users')
        .then(response => response.json())
        .then(data => {
            displayParticipants(data.users);
        })
        .catch(error => {
            console.error('Error loading participants:', error);
        });
}

function displayParticipants(participants) {
    const tbody = document.getElementById('participants-table');
    tbody.innerHTML = participants.map(participant => `
        <tr>
            <td>
                <div class="d-flex align-items-center">
                    <div class="avatar-circle me-3">
                        <i class="fas fa-user"></i>
                    </div>
                    <div>
                        <div class="fw-bold">${participant.name}</div>
                        <small class="text-muted">${participant.email}</small>
                    </div>
                </div>
            </td>
            <td class="text-center">
                <span class="participant-score ${getScoreClass(participant.score)}">
                    ${participant.score}%
                </span>
            </td>
            <td class="text-center">
                <span class="badge bg-primary">${participant.analyses}</span>
            </td>
            <td class="text-center">
                <small class="text-muted">Hace 2 horas</small>
            </td>
            <td class="text-center">
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" onclick="viewParticipant(${participant.id})">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-outline-danger" onclick="removeParticipant(${participant.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}

function getScoreClass(score) {
    if (score >= 80) return 'score-high';
    if (score >= 60) return 'score-medium';
    return 'score-low';
}

function loadStatistics() {
    // Simular carga de estadísticas
    document.getElementById('total-participants').textContent = '127';
    document.getElementById('total-analyses').textContent = '456';
    document.getElementById('avg-score').textContent = '73%';
    document.getElementById('best-score').textContent = '94%';
}

function setupEventListeners() {
    // Formulario de asignación de rol
    document.getElementById('assign-role-form').addEventListener('submit', function(e) {
        e.preventDefault();
        assignChallengeRole();
    });

    // Botones de exportación
    document.getElementById('export-participants-btn').addEventListener('click', function() {
        exportData('participants');
    });

    document.getElementById('export-results-btn').addEventListener('click', function() {
        exportData('results');
    });

    document.getElementById('export-analyses-btn').addEventListener('click', function() {
        exportData('analyses');
    });

    // Botón de guardar configuración
    document.getElementById('save-config-btn').addEventListener('click', function() {
        saveConfiguration();
    });
}

function assignChallengeRole() {
    const email = document.getElementById('user-email').value;
    
    if (!email) {
        alert('{{ _("Por favor ingresa un email válido") }}');
        return;
    }

    fetch('/challenge/admin/assign-role', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ email: email })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            document.getElementById('user-email').value = '';
            loadParticipants(); // Recargar lista
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('{{ _("Error al asignar rol") }}');
    });
}

function viewParticipant(id) {
    // Implementar vista detallada del participante
    alert('{{ _("Vista detallada del participante") }} ' + id);
}

function removeParticipant(id) {
    if (confirm('{{ _("¿Estás seguro de que quieres remover a este participante?") }}')) {
        // Implementar remoción del participante
        alert('{{ _("Participante removido") }}');
        loadParticipants(); // Recargar lista
    }
}

function exportData(type) {
    // Implementar exportación de datos
    alert('{{ _("Exportando datos de") }} ' + type);
}

function saveConfiguration() {
    const config = {
        active: document.getElementById('challenge-active').checked,
        newRegistrations: document.getElementById('new-registrations').checked,
        showResults: document.getElementById('show-results').checked
    };
    
    // Implementar guardado de configuración
    alert('{{ _("Configuración guardada") }}');
}
</script>
{% endblock %}
