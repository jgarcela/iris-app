{% extends "challenge/challenge_base.html" %}

{% block title %}{{ _('Resultados del Análisis con IA') }} - {{ text_data.title }}{% endblock %}

{% block challenge_content %}
<div class="container-fluid py-4">
    <!-- Header de Resultados -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-1">
                        <i class="fas fa-robot me-2 text-primary"></i>
                        {{ _('Resultados del Análisis con IA') }}
                    </h2>
                    <p class="text-muted mb-0">
                        <span class="badge 
                            {% if text_data.difficulty == 'Fácil' %}bg-success
                            {% elif text_data.difficulty == 'Medio' %}bg-warning
                            {% else %}bg-danger{% endif %} me-2">
                            {{ text_data.difficulty }}
                        </span>
                        {{ text_data.title }}
                    </p>
                </div>
                <div>
                    <a href="{{ url_for('challenge.challenge_home') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>
                        {{ _('Volver al Desafío') }}
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Comparación de Análisis -->
    <div class="row">
        <!-- Análisis Manual -->
        <div class="col-lg-6 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-user-edit me-2"></i>
                        {{ _('Tu Análisis Manual') }}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="analysis-summary">
                        <p><strong>{{ _('Anotaciones realizadas:') }}</strong> <span id="manual-annotations-count">0</span></p>
                        <div id="manual-annotations-list" class="annotations-list">
                            <!-- Anotaciones manuales se cargan aquí -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Análisis de IA -->
        <div class="col-lg-6 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-robot me-2"></i>
                        {{ _('Análisis de IA') }}
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Tabs para elegir vista de dificultad del análisis IA -->
                    <ul class="nav nav-pills mb-3" id="ai-difficulty-tabs">
                        <li class="nav-item">
                            <button class="nav-link" id="tab-easy" onclick="switchAIView('easy')">{{ _('Fácil') }}</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" id="tab-medium" onclick="switchAIView('medium')">{{ _('Medio') }}</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" id="tab-hard" onclick="switchAIView('hard')">{{ _('Difícil') }}</button>
                        </li>
                    </ul>
                    <div class="ai-summary">
                        <p><strong>{{ _('Variables detectadas:') }}</strong> <span id="ai-variables-count">0</span></p>
                        <div id="ai-analysis-details">
                            <!-- Análisis de IA se carga aquí -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Métricas de Comparación -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-line me-2"></i>
                        {{ _('Métricas de Comparación') }}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-4">
                            <div class="metric-item">
                                <div class="metric-value" id="precision-score">0%</div>
                                <div class="metric-label">{{ _('Precisión') }}</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="metric-item">
                                <div class="metric-value" id="recall-score">0%</div>
                                <div class="metric-label">{{ _('Cobertura') }}</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="metric-item">
                                <div class="metric-value score-highlight" id="total-score">0%</div>
                                <div class="metric-label">{{ _('Puntuación Total') }}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Detalles del Texto Analizado -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-file-alt me-2"></i>
                        {{ _('Texto Analizado') }}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="text-content" id="analyzed-text">
                        <p>{{ text_data.text }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Acciones -->
    <div class="row">
        <div class="col-12 text-center">
            <div class="action-buttons">
                <a href="{{ url_for('challenge.challenge_home') }}" class="btn btn-primary btn-lg me-3">
                    <i class="fas fa-redo me-2"></i>
                    {{ _('Analizar Otro Texto') }}
                </a>
                <a href="{{ url_for('challenge.results') }}" class="btn btn-outline-primary btn-lg">
                    <i class="fas fa-trophy me-2"></i>
                    {{ _('Ver Ranking') }}
                </a>
            </div>
        </div>
    </div>
</div>

<style>
.analysis-summary, .ai-summary {
    min-height: 200px;
}

.annotations-list {
    max-height: 300px;
    overflow-y: auto;
}

.annotation-item {
    background: #f8f9fa;
    padding: 0.75rem;
    border-radius: 6px;
    margin-bottom: 0.5rem;
    border-left: 4px solid #007bff;
}

.annotation-text {
    font-size: 0.9rem;
    color: #495057;
    margin-bottom: 0.25rem;
}

.annotation-meta {
    font-size: 0.8rem;
    color: #6c757d;
}

.metric-item {
    padding: 1rem;
}

.metric-value {
    font-size: 2.5rem;
    font-weight: bold;
    color: #495057;
    margin-bottom: 0.5rem;
}

.metric-label {
    color: #6c757d;
    font-weight: 600;
}

.score-highlight {
    color: #28a745 !important;
}

.ai-category {
    margin-bottom: 1rem;
}

.ai-category h6 {
    color: #495057;
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.ai-category ul {
    margin: 0;
    padding-left: 1.2rem;
}

.ai-category li {
    margin-bottom: 0.25rem;
    font-size: 0.9rem;
}

.text-content {
    line-height: 1.8;
    font-size: 1.1rem;
    color: #495057;
}

.action-buttons {
    margin-top: 2rem;
}
</style>

<script>
// Datos desde el backend
const manualAnnotations = {{ manual_annotations | tojson | safe }};
const analyses = {
  easy: {{ ai_analysis_easy | tojson | safe }},
  medium: {{ ai_analysis_medium | tojson | safe }},
  hard: {{ ai_analysis_hard | tojson | safe }}
};
let currentDifficulty = {{ current_difficulty | tojson | safe }};
let aiAnalysis = analyses[currentDifficulty] || {};

document.addEventListener('DOMContentLoaded', function() {
  updateDifficultyTabs();
  loadAnalysisResults();
});

function switchAIView(level) {
  currentDifficulty = level;
  aiAnalysis = analyses[level] || {};
  updateDifficultyTabs();
  loadAIAnalysis();
}

function updateDifficultyTabs() {
  const levels = ['easy','medium','hard'];
  levels.forEach(l => {
    const el = document.getElementById(`tab-${l}`);
    if (!el) return;
    el.classList.toggle('active', l === currentDifficulty);
  });
}

function loadAnalysisResults() {
  loadManualAnnotations();
  loadAIAnalysis();
  calculateMetrics();
}

function loadManualAnnotations() {
  const container = document.getElementById('manual-annotations-list');
  const countElement = document.getElementById('manual-annotations-count');
  countElement.textContent = manualAnnotations.length;
  if (manualAnnotations.length === 0) {
    container.innerHTML = '<p class="text-muted text-center py-3"><i class="fas fa-info-circle me-2"></i>{{ _("No se realizaron anotaciones manuales") }}</p>';
    return;
  }
  container.innerHTML = manualAnnotations.map(annotation => `
    <div class="annotation-item">
      <div class="annotation-text">"${annotation.text}"</div>
      <div class="annotation-meta">
        <strong>${annotation.category.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</strong> → 
        ${annotation.variable.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())} = ${annotation.value}
      </div>
    </div>
  `).join('');
}

function loadAIAnalysis() {
  const container = document.getElementById('ai-analysis-details');
  const countElement = document.getElementById('ai-variables-count');

  // Render según dificultad
  if (currentDifficulty === 'easy' && Array.isArray(aiAnalysis.sesgos)) {
    countElement.textContent = aiAnalysis.sesgos.length;
    container.innerHTML = `
      <div class="ai-category">
        <h6>{{ _("Sesgos detectados") }}</h6>
        <ul>
          ${aiAnalysis.sesgos.map(s => `<li>${s}</li>`).join('')}
        </ul>
      </div>
    `;
    return;
  }

  // Medium / Hard (categorías)
  let totalVariables = 0;
  const cg = aiAnalysis.contenido_general || {};
  const lg = aiAnalysis.lenguaje || {};
  const ft = aiAnalysis.fuentes || {};

  // Contador básico (número de campos con valor no vacío)
  [cg, lg, ft].forEach(group => {
    if (!group) return;
    Object.values(group).forEach(v => { if (v && (Array.isArray(v) ? v.length : String(v).length)) totalVariables++; });
  });
  countElement.textContent = totalVariables;

  container.innerHTML = `
    <div class="ai-category">
      <h6>{{ _("Contenido General") }}</h6>
      <ul>
        <li>{{ _("Personas mencionadas:") }} ${cg.personas_mencionadas ?? 'N/A'}</li>
        <li>{{ _("Género periodista:") }} ${cg.genero_periodista ?? 'N/A'}</li>
        <li>{{ _("Tema:") }} ${cg.tema ?? 'N/A'}</li>
      </ul>
    </div>
    <div class="ai-category">
      <h6>{{ _("Lenguaje") }}</h6>
      <ul>
        <li>{{ _("Lenguaje sexista:") }} ${lg.lenguaje_sexista ?? 'N/A'}</li>
        <li>{{ _("Androcentrismo:") }} ${lg.androcentrismo ?? 'N/A'}</li>
        <li>{{ _("Asimetría:") }} ${lg.asimetria ?? 'N/A'}</li>
        <li>{{ _("Infantilización:") }} ${lg.infantilizacion ?? 'N/A'}</li>
        <li>{{ _("Masculino genérico:") }} ${lg.masculino_generico ?? 'N/A'}</li>
      </ul>
    </div>
    <div class="ai-category">
      <h6>{{ _("Fuentes") }}</h6>
      <ul>
        <li>{{ _("Nombre fuente:") }} ${ft.nombre_fuente ?? 'N/A'}</li>
        <li>{{ _("Género fuente:") }} ${ft.genero_fuente ?? 'N/A'}</li>
        <li>{{ _("Tipo fuente:") }} ${ft.tipo_fuente ?? 'N/A'}</li>
      </ul>
    </div>
  `;
}

function calculateMetrics() {
  // Métrica demo simple
  const detectedVariables = manualAnnotations.length;
  const aiCount = document.getElementById('ai-variables-count').textContent;
  const aiDetectedVariables = Math.max(1, parseInt(aiCount, 10));
  const precision = Math.min(100, (detectedVariables / (detectedVariables + Math.max(0, aiDetectedVariables - detectedVariables))) * 100) || 0;
  const recall = Math.min(100, (detectedVariables / aiDetectedVariables) * 100) || 0;
  const totalScore = Math.round((precision + recall) / 2);
  document.getElementById('precision-score').textContent = Math.round(precision) + '%';
  document.getElementById('recall-score').textContent = Math.round(recall) + '%';
  document.getElementById('total-score').textContent = totalScore + '%';
}
</script>
{% endblock %}
