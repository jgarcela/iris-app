{% extends "base.html" %}

{% block title %}{{ _('Resultados') }} - IRIS{% endblock %}





{% block content %}

<div class="container-fluid py-4">
  <div class="row g-4">
    <!-- Left Panel: Analysis Tools -->
    <div class="col-md-4">
      <!-- Panel 1: Analysis Tools -->
      <div class="analysis-tools-panel mb-3">
        <h4 class="panel-title">
          <i class="fas fa-tools me-2"></i>{{ _('Herramientas de Análisis') }}
        </h4>
        <div class="action-buttons">
          <!-- Model Info -->
          <div class="model-info mb-3 p-3 bg-light rounded">
            <div class="d-flex align-items-center">
              <i class="fas fa-brain text-primary me-2"></i>
              <div>
                <small class="text-muted d-block">{{ _('Modelo seleccionado') }}</small>
                <strong class="text-primary">{{ data.model | title }}</strong>
              </div>
            </div>
          </div>
          
          <!-- Action Buttons -->
          <a href="{{ url_for('analysis.generate_report', doc_id=data._id) }}" class="btn btn-outline-danger w-100 mb-2">
            <i class="fas fa-file-pdf me-2"></i>{{ _('Generar PDF') }}
          </a>
          <a href="{{ url_for('analysis.generate_report_word', doc_id=data._id) }}" class="btn btn-outline-primary w-100 mb-2">
            <i class="fas fa-file-word me-2"></i>{{ _('Generar Word') }}
          </a>
          <a href="/" class="btn btn-success w-100">
            <i class="fas fa-flag-checkered me-2"></i>{{ _('Finalizar análisis') }}
          </a>
        </div>
      </div>

      <!-- Panel 2: Analysis Results -->
      <div class="analysis-tools-panel">
        <h4 class="panel-title">
          <i class="fas fa-chart-bar me-2"></i>{{ _('Resultados del Análisis') }}
        </h4>
        <p class="text-muted small mb-3">{{ _('Selecciona cada apartado individualmente para ver el texto resaltado correspondiente') }}</p>
        
        <!-- Inclusivity Score -->
        <div class="analysis-tools-panel mb-3">
          <h5 class="panel-title collapsible-header" data-target="inclusivity-content">
            <i class="fas fa-heart me-2"></i>{{ _('Puntuación de inclusividad') }}
            <i class="fas fa-chevron-down toggle-icon ms-auto"></i>
          </h5>
          <div class="collapsible-content" id="inclusivity-content">
            <div class="score-bar">
              <div class="fill" style="width: {{ score }}%;"></div>
            </div>
            <div class="score-value">{{ score }}/100</div>
            <div class="metrics">
              <div class="metric">
                <span class="label">{{ _('Total palabras') }}</span>
                <span class="value">{{ total_words }}</span>
              </div>
              <div class="metric">
                <span class="label">{{ _('Términos sesgados') }}</span>
                <span class="value">{{ biased_terms|length }}</span>
              </div>
              <div class="metric">
                <span class="label">{{ _('Términos inclusivos') }}</span>
                <span class="value">{{ inclusive_terms|length }}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Content General -->
        <div class="analysis-tools-panel mb-3">
          <h5 class="panel-title collapsible-header" data-target="contenido-content">
            <i class="fas fa-list me-2"></i>{{ _('Contenido General') }}
            <i class="fas fa-chevron-down toggle-icon ms-auto"></i>
          </h5>
          <div class="collapsible-content" id="contenido-content">
            <ul class="list-unstyled">
              {% for key, value in data.analysis.original.contenido_general.items() %}
              {% set color = highlight_map.get(key, "#ffffff") %}
              <li class="mb-2">
                <mark class="{{ color }}"><strong>{{ key }}:</strong></mark> {{ value }}
              </li>
              {% endfor %}
            </ul>
          </div>
        </div>

        <!-- Language Analysis -->
        <div class="analysis-tools-panel mb-3">
          <h5 class="panel-title collapsible-header" data-target="lenguaje-content">
            <i class="fas fa-language me-2"></i>{{ _('Lenguaje y Análisis del discurso') }}
            <i class="fas fa-chevron-down toggle-icon ms-auto"></i>
          </h5>
          <div class="collapsible-content" id="lenguaje-content">
            <ul class="list-unstyled">
              {% for key, value in data.analysis.original.lenguaje.items() %}
              {% set color = highlight_map.get(key, "#ffffff") %}
              <li class="mb-2">
                <mark class="{{ color }}"><strong>{{ key }}:</strong></mark> {{ value }}
              </li>
              {% endfor %}
            </ul>
          </div>
        </div>

        <!-- Sources -->
        <div class="analysis-tools-panel mb-3">
          <h5 class="panel-title collapsible-header" data-target="fuentes-content">
            <i class="fas fa-quote-left me-2"></i>{{ _('Fuentes de información') }}
            <i class="fas fa-chevron-down toggle-icon ms-auto"></i>
          </h5>
          <div class="collapsible-content" id="fuentes-content">
            <ul class="list-unstyled">
              {% for fuente in data.analysis.original.fuentes.fuentes %}
                {% for key, value in fuente.items() %}
                {% set color = highlight_map.get(key, "#ffffff") %}
                <li class="mb-2">
                  <mark class="{{ color }}"><strong>{{ key }}:</strong></mark> {{ value }}
                </li>
                {% endfor %}
              {% endfor %}
            </ul>
          </div>
        </div>

        <!-- Recommendations -->
        <div class="analysis-tools-panel">
          <h5 class="panel-title collapsible-header" data-target="recommendations-content">
            <i class="fas fa-lightbulb me-2"></i>{{ _('Recomendaciones generales') }}
            <i class="fas fa-chevron-down toggle-icon ms-auto"></i>
          </h5>
          <div class="collapsible-content" id="recommendations-content">
            <ul class="list-unstyled">
              {% for rec in recommendations %}
              <li class="mb-2"><i class="fas fa-arrow-right text-primary me-2"></i>{{ rec }}</li>
              {% endfor %}
            </ul>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Panel: Text Content -->
    <div class="col-md-8">
      <div class="text-container">
        <!-- Si hay título o autoría, los mostramos antes del texto -->
        {% if data.title or data.authors or data.url %}
        <div class="article-meta">
            {% if data.title %}
                <h2>{{ data.title }}</h2>
            {% endif %}

            {% if data.authors %}
                <p><strong>Autoría:</strong>
                    {{ data.authors if data.authors is string else data.authors | join(', ') }}
                </p>
            {% endif %}


            {% if data.url %}
                <p><strong>Fuente:</strong> <a href="{{ data.url }}" target="_blank">{{ data.url }}</a></p>
            {% endif %}
        </div>
        {% endif %}

        <!-- 1. Texto plain: siempre visible -->
        <div class="plain-text">
            <p>{{ data.text | replace('\n\n', '</p><p>') | safe }}</p>
        </div>

        <!-- 2. Texto highlighted: oculto hasta abrir -->
        <div class="highlight-text" style="display: none;">
            <div class="highlight-controls" style="margin-bottom: 10px;">
                <button id="edit-mode-toggle" class="edit-button">
                  <i class="fa fa-pen"></i> Editar
                </button>  
              
                <button id="save-changes" class="save-button" style="display: none;">
                  <i class="fa fa-save"></i> Guardar cambios
                </button>
              </div>
              
            <div class="markup-area">
                <p>{{ data.text | replace('\n\n', '</p><p>') | safe }}</p>
            </div>
        </div>
        <!-- Tooltip predicciones -->
        <div id="tooltip" class="custom-tooltip">
            <i class="fas fa-check" title="Aceptar"></i>
            <i class="fas fa-times" title="Rechazar"></i>
        </div> 
        <!-- Tooltip new -->
        <div id="variable-tooltip" class="custom-tooltip" style="display: none;">
            {% for var in contenido_general_variables %}
                <button class="var-btn" data-block="contenido" data-variable="{{ var|lower|replace(' ', '_') }}">{{ var }}</button>
            {% endfor %}
            {% for var in lenguaje_variables %}
                <button class="var-btn" data-block="lenguaje" data-variable="{{ var|lower|replace(' ', '_') }}">{{ var }}</button>
            {% endfor %}
            {% for var in fuentes_variables %}
                <button class="var-btn" data-block="fuentes" data-variable="{{ var|lower|replace(' ', '_') }}">{{ var }}</button>
            {% endfor %}
        </div>
                  
        <!-- Si hay título o autoría, los mostramos antes del texto -->
        {% if data.title or data.authors or data.url %}
        <div class="article-meta">
            {% if data.title %}
                <h2>{{ data.title }}</h2>
            {% endif %}

            {% if data.authors %}
                <p><strong>Autoría:</strong>
                    {{ data.authors if data.authors is string else data.authors | join(', ') }}
                </p>
            {% endif %}

            {% if data.url %}
                <p><strong>Fuente:</strong> <a href="{{ data.url }}" target="_blank">{{ data.url }}</a></p>
            {% endif %}
        </div>
        {% endif %}

        <!-- 1. Texto plain: siempre visible -->
        <div class="plain-text">
            <p>{{ data.text | replace('\n\n', '</p><p>') | safe }}</p>
        </div>

        <!-- 2. Texto highlighted: oculto hasta abrir -->
        <div class="highlight-text" style="display: none;">
            <div class="highlight-controls" style="margin-bottom: 10px;">
                <button id="edit-mode-toggle" class="edit-button">
                  <i class="fa fa-pen"></i> Editar
                </button>  
              
                <button id="save-changes" class="save-button" style="display: none;">
                  <i class="fa fa-save"></i> Guardar cambios
                </button>
              </div>
              
            <div class="markup-area">
                <p>{{ data.text | replace('\n\n', '</p><p>') | safe }}</p>
            </div>
        </div>
        <!-- Tooltip predicciones -->
        <div id="tooltip" class="custom-tooltip">
            <i class="fas fa-check" title="Aceptar"></i>
            <i class="fas fa-times" title="Rechazar"></i>
        </div> 
        <!-- Tooltip new -->
        <div id="variable-tooltip" class="custom-tooltip" style="display: none;">
            {% for var in contenido_general_variables %}
                <button class="var-btn" data-block="contenido" data-variable="{{ var|lower|replace(' ', '_') }}">{{ var }}</button>
            {% endfor %}
            {% for var in lenguaje_variables %}
                <button class="var-btn" data-block="lenguaje" data-variable="{{ var|lower|replace(' ', '_') }}">{{ var }}</button>
            {% endfor %}
            {% for var in fuentes_variables %}
                <button class="var-btn" data-block="fuentes" data-variable="{{ var|lower|replace(' ', '_') }}">{{ var }}</button>
            {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>


<script>
    window.data = {{ data | tojson | safe }};
    window.highlight_color_map = {{ highlight_map | safe }};
    window.api_url_edit = {{ api_url_edit | tojson | safe }};
</script>
<script type="module" src="{{ url_for('static', filename='js/accordion.js') }}"></script>
<script type="module" src="{{ url_for('static', filename='js/highlight_prediction.js') }}"></script>
<script type="module" src="{{ url_for('static', filename='js/highlight_tooltip.js') }}"></script>
<script type="module" src="{{ url_for('static', filename='js/highlight_human.js') }}"></script>


{% endblock %}
