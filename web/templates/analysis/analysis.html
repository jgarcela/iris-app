{% extends "base.html" %}

{% block title %}{{ _('Resultados') }} - IRIS{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Header -->
            <div class="history-header mb-4">
                <h1 class="display-6 mb-3">
                    <i class="fas fa-file-alt me-3 text-primary"></i>
                    {{ _('Análisis Automático') }}
                </h1>
                <p class="lead text-muted">
                    {{ _('Análisis automático del contenido con herramientas de edición y anotación') }}
                </p>
            </div>
        </div>
    </div>
    <div class="row">
        <!-- Left Column - Analysis Tools -->
        <div class="col-md-4">
            <!-- Analysis Tools Panel -->
            <div class="analysis-tools-panel tools-panel-minimal">
                <div class="panel-header-minimal">
                    <h6 class="panel-title-minimal">
                        <i class="fas fa-tools me-2"></i>
                        {{ _('Herramientas de Análisis') }}
                    </h6>
                </div>
                
                <!-- Model Info Minimal -->
                <div class="model-info-minimal">
                    <span class="model-label">{{ _('Modelo') }}:</span>
                    <span class="model-value" id="selected-model">{{ data.model }}</span>
                </div>
                
                <!-- Export Buttons -->
                <div class="button-group">
                    <div class="button-group-title">
                        <i class="fas fa-download me-1"></i>
                        {{ _('Exportar') }}
                    </div>
                    <div class="action-buttons-minimal">
                        <button class="btn-minimal btn-export" onclick="generatePDF()">
                            <i class="fas fa-file-pdf me-2"></i>
                            {{ _('PDF') }}
                        </button>
                        <button class="btn-minimal btn-export" onclick="generateWord()">
                            <i class="fas fa-file-word me-2"></i>
                            {{ _('Word') }}
                        </button>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="button-group">
                    <div class="button-group-title">
                        <i class="fas fa-cogs me-1"></i>
                        {{ _('Acciones') }}
                    </div>
                    <div class="action-buttons-minimal">
                        <button class="btn-minimal btn-edit-mode" id="edit-analysis-btn" onclick="editAnalysis()" disabled>
                            <i class="fas fa-edit me-2"></i>
                            {{ _('Editar Análisis') }}
                        </button>
                        <a class="btn-minimal" href="{{ url_for('glossary.glossary_home') }}">
                            <i class="fas fa-book me-2"></i>
                            {{ _('Glosario de variables') }}
                        </a>
                        <button class="btn-minimal btn-save" onclick="saveAnalysisToDatabase()" id="save-analysis-btn" style="display: none;">
                            <i class="fas fa-save me-2"></i>
                            {{ _('Guardar') }}
                        </button>
                        <button class="btn-minimal btn-finish" onclick="finishAnalysis()">
                            <i class="fas fa-check me-2"></i>
                            {{ _('Finalizar') }}
                        </button>
                    </div>
                </div>
            </div>

            <!-- Help / Info Panel as dropdown -->
            <div class="analysis-tools-panel">
                <div class="collapsible-header" data-target="help-content">
                    <h5 class="panel-title mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        {{ _('Cómo editar anotaciones') }}
                    </h5>
                    <i class="fas fa-chevron-down toggle-icon"></i>
                </div>
                <div id="help-content" class="collapsible-content">
                    <div class="small">
                        <div class="mb-2"><strong>{{ _('Editar/aceptar/eliminar') }}:</strong> {{ _('haz clic en cualquier texto resaltado para abrir el menú de acciones. Al aceptar verás un check junto al fragmento.') }}</div>
                        <div class="mb-2"><strong>{{ _('Crear anotaciones nuevas') }}:</strong> {{ _('selecciona un fragmento del texto y elige la variable/valor desde el panel; se abrirá un selector con opciones válidas.') }}</div>
                        <div class="mb-2"><strong>{{ _('Nota') }}:</strong> {{ _('No es necesario anotar cada una de las variables; marca solo las que identifiques en el texto. Es normal que un texto no contenga todas las variables posibles.') }}</div>
                        <div class="mb-0"><strong>{{ _('Guardar cambios') }}:</strong> {{ _('usa el botón Guardar del panel para persistir las anotaciones.') }}</div>
                    </div>
                </div>
            </div>

            <!-- Inclusivity Score as dropdown -->
            <div class="analysis-tools-panel">
                <div class="collapsible-header" data-target="score-content">
                    <h5 class="panel-title mb-0">
                        <i class="fas fa-chart-line me-2"></i>
                        {{ _('Puntuación de Inclusividad') }}
                    </h5>
                    <i class="fas fa-chevron-down toggle-icon"></i>
                </div>
                <div id="score-content" class="collapsible-content">
                    <div class="score-value">{{ data.analysis.original.inclusivity_score }}%</div>
                    <div class="score-bar">
                        <div class="fill" style="width: {{ data.analysis.original.inclusivity_score }}%"></div>
                    </div>
                    <div class="metrics">
                        <div class="metric">
                            <span class="label">{{ _('Contenido General') }}</span>
                            <span class="value">{{ data.analysis.original.contenido_general_score }}%</span>
                        </div>
                        <div class="metric">
                            <span class="label">{{ _('Lenguaje') }}</span>
                            <span class="value">{{ data.analysis.original.lenguaje_score }}%</span>
                        </div>
                        <div class="metric">
                            <span class="label">{{ _('Fuentes') }}</span>
                            <span class="value">{{ data.analysis.original.fuentes_score }}%</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recomendaciones -->
            <div class="analysis-tools-panel">
                <div class="collapsible-header" data-target="recomendaciones-content">
                    <h5 class="panel-title mb-0">
                        <i class="fas fa-lightbulb me-2"></i>
                        {{ _('Recomendaciones') }}
                    </h5>
                    <i class="fas fa-chevron-down toggle-icon"></i>
                </div>
                <div id="recomendaciones-content" class="collapsible-content">
                    <ul class="list-unstyled">
                        {% for recommendation in data.analysis.original.recommendations %}
                        <li>{{ recommendation }}</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>

            <!-- Categories Section -->
            <div class="categories-section">
                <div class="categories-header">
                    <h6 class="categories-title">
                        <i class="fas fa-list-ul me-2"></i>
                        {{ _('Categorías') }}
                    </h6>
                </div>
                
                <!-- Contenido General -->
                <div class="analysis-tools-panel">
                    <div class="collapsible-header" data-target="contenido-content">
                        <h5 class="panel-title mb-0">
                            <i class="fas fa-newspaper me-2"></i>
                            {{ _('Contenido General') }}
                        </h5>
                        <i class="fas fa-chevron-down toggle-icon"></i>
                    </div>
                    <div id="contenido-content" class="collapsible-content">
                        <div id="contenido-variables" class="variables-grid">
                            <!-- Variables will be rendered by JavaScript -->
                        </div>
                    </div>
                </div>

                <!-- Lenguaje y Análisis del discurso -->
                <div class="analysis-tools-panel">
                    <div class="collapsible-header" data-target="lenguaje-content">
                        <h5 class="panel-title mb-0">
                            <i class="fas fa-language me-2"></i>
                            {{ _('Lenguaje y Análisis del discurso') }}
                        </h5>
                        <i class="fas fa-chevron-down toggle-icon"></i>
                    </div>
                    <div id="lenguaje-content" class="collapsible-content">
                        <div id="lenguaje-variables" class="variables-grid">
                            <!-- Variables will be rendered by JavaScript -->
                        </div>
                    </div>
                </div>

                <!-- Fuentes de información -->
                <div class="analysis-tools-panel">
                    <div class="collapsible-header" data-target="fuentes-content">
                        <h5 class="panel-title mb-0">
                            <i class="fas fa-users me-2"></i>
                            {{ _('Fuentes de información') }}
                        </h5>
                        <i class="fas fa-chevron-down toggle-icon"></i>
                    </div>
                    <div id="fuentes-content" class="collapsible-content">
                        <div id="fuentes-sources" class="sources-grid">
                            <!-- Sources will be rendered by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Protagonismo Section -->
            <div class="categories-section">
                <div class="categories-header">
                    <h6 class="categories-title">
                        <i class="fas fa-list-ul me-2"></i>
                        {{ _('PROTAGONISMO') }}
                    </h6>
                </div>
                
                 <!-- Protagonist Analysis Dropdown -->
                <div class="analysis-tools-panel">
                    <div class="collapsible-header" data-target="protagonist-content">
                        <h5 class="panel-title mb-0">
                            <i class="fas fa-user-star me-2"></i>
                            {{ _('Protagonista de la Noticia') }}
                        </h5>
                        <i class="fas fa-chevron-down toggle-icon"></i>
                    </div>
                    <div id="protagonist-content" class="collapsible-content">
                        <div id="protagonist-analysis" class="text-center py-3">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">{{ _('Analizando...') }}</span>
                            </div>
                            <p class="text-muted mt-2">{{ _('Analizando protagonista...') }}</p>
                        </div>
                    </div>
                </div>
            </div>
            
           
            <!-- Tema Section -->
            <div class="categories-section">
                <div class="categories-header">
                    <h6 class="categories-title">
                        <i class="fas fa-list-ul me-2"></i>
                        {{ _('TEMA') }}
                    </h6>
                </div>

                <!-- Topic Analysis Dropdown -->
                <div class="analysis-tools-panel">
                    <div class="collapsible-header" data-target="topic-content">
                        <h5 class="panel-title mb-0">
                            <i class="fas fa-tag me-2"></i>
                            {{ _('Tema de la Noticia') }}
                        </h5>
                        <i class="fas fa-chevron-down toggle-icon"></i>
                    </div>
                    <div id="topic-content" class="collapsible-content">
                        <div id="topic-analysis" class="text-center py-3">
                            <div class="spinner-border text-success" role="status">
                                <span class="visually-hidden">{{ _('Analizando...') }}</span>
                            </div>
                            <p class="text-muted mt-2">{{ _('Analizando tema...') }}</p>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>

        <!-- Right Column - Instructions -->
        <div class="col-md-8">
            <!-- Instructions Panel (shown by default) -->
            <div class="plain-text">
                <div class="instructions-panel">
                    <div class="instructions-content">
                        <div class="instructions-header">
                            <h4 class="instructions-title">¿Cómo proceder?</h4>
                            <p class="instructions-subtitle">Elige una categoría del menú de la izquierda para comenzar</p>
                        </div>
                        
                        <div class="instructions-steps">
                            <div class="step">
                                <div class="step-number">1</div>
                                <div class="step-content">
                                    <h6 class="step-title">Selecciona una categoría</h6>
                                    <p class="step-description">Contenido General, Lenguaje o Fuentes</p>
                                </div>
                            </div>
                            
                            <div class="step">
                                <div class="step-number">2</div>
                                <div class="step-content">
                                    <h6 class="step-title">Revisa las anotaciones</h6>
                                    <p class="step-description">Observa los resaltados en el texto</p>
                                </div>
                            </div>
                            
                            <div class="step">
                                <div class="step-number">3</div>
                                <div class="step-content">
                                    <h6 class="step-title">Edita y valida</h6>
                                    <p class="step-description">Haz clic en los resaltados para editar</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Text Analysis Panel (shown when categories are expanded) -->
            <div class="text-analysis-panel" style="display: none;">
                <h5 class="panel-title">
                    <i class="fas fa-file-alt me-2"></i>
                    {{ _('Análisis del Texto') }}
                </h5>
                
                <!-- Highlighted Text Content -->
                <div class="highlight-text">
                    <div class="small text-muted mb-2"><i class="fas fa-mouse-pointer me-1"></i>Haz clic sobre un resaltado para editar, aceptar o eliminar la anotación.</div>
                    
                    <!-- Contenido General Highlights -->
                    <div id="highlight-contenido" class="highlight-block highlight-contenido" style="display: none;">
                        <h6 class="mb-3">{{ _('Contenido General') }}</h6>
                        <div class="markup-area">{{ data.highlight.original.contenido_general | safe }}</div>
                    </div>
                    
                    <!-- Lenguaje Highlights -->
                    <div id="highlight-lenguaje" class="highlight-block highlight-lenguaje" style="display: none;">
                        <h6 class="mb-3">{{ _('Lenguaje y Análisis del discurso') }}</h6>
                        <div class="markup-area">{{ data.highlight.original.lenguaje | safe }}</div>
                    </div>
                    
                    <!-- Fuentes Highlights -->
                    <div id="highlight-fuentes" class="highlight-block highlight-fuentes" style="display: none;">
                        <h6 class="mb-3">{{ _('Fuentes de información') }}</h6>
                        <div class="markup-area">{{ data.highlight.original.fuentes | safe }}</div>
                    </div>
                </div>
            </div>
            </div>
        </div>
    </div>
</div>

<!-- Highlight tooltip -->
<div id="highlight-tooltip" class="highlight-tooltip">
    <div class="tooltip-title"></div>
    <div class="tooltip-description"></div>
</div>

<!-- Generic Modal for edits -->
<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editModalTitle">Editar</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="editModalForm">
          <div class="mb-3" id="singleInputGroup" style="display:none;">
            <label class="form-label" id="singleInputLabel">Valor</label>
            <input type="text" class="form-control" id="singleInput" />
          </div>
          <div class="mb-3" id="selectInputGroup" style="display:none;">
            <label class="form-label" id="selectInputLabel">Selecciona</label>
            <select class="form-select" id="selectInput"></select>
            <div class="form-text" id="selectHelp" style="display:none;">Puedes seleccionar múltiples valores manteniendo Ctrl/⌘.</div>
          </div>
          <div id="fuenteForm" style="display:none;">
            <div class="mb-2">
              <label class="form-label">Nombre de la fuente</label>
              <input type="text" class="form-control" id="fuenteNombre" />
            </div>
            <div class="mb-2">
              <label class="form-label">Declaración</label>
              <textarea class="form-control" id="fuenteDeclaracion" rows="3"></textarea>
            </div>
            <div class="mb-2">
              <label class="form-label">Tipo (clave)</label>
              <input type="text" class="form-control" id="fuenteTipo" />
            </div>
            <div class="mb-2">
              <label class="form-label">Género (clave)</label>
              <input type="text" class="form-control" id="fuenteGenero" />
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" id="editModalSave">Guardar</button>
      </div>
    </div>
  </div>
  </div>

<script>
    window.data = {{ data | tojson | safe }};
    window.highlight_color_map = {{ highlight_map | safe }};
    window.api_url_edit = {{ api_url_edit | tojson | safe }};
    window.api_url_save_annotations = {{ api_url_save_annotations | tojson | safe }};
    
    // Initialize protagonist and topic analysis
    document.addEventListener('DOMContentLoaded', function() {
        updateProtagonistAnalysis();
        updateTopicAnalysis();
    });
    
    function updateProtagonistAnalysis() {
        const protagonistDiv = document.getElementById('protagonist-analysis');
        if (!protagonistDiv) return;
        
        if (!window.data) {
            protagonistDiv.innerHTML = `
                <div class="protagonist-result">
                    <div class="no-data">
                        <i class="fas fa-exclamation-triangle text-warning mb-2"></i>
                        <p class="text-muted mb-0">No hay datos disponibles</p>
                    </div>
                </div>
            `;
            return;
        }
        
        // Get protagonist analysis from data
        const protagonistData = window.data.protagonist_analysis || {};
        const protagonist = protagonistData.protagonist || 'No identificado';
        const confidence = protagonistData.confidence || 0;
        const counts = protagonistData.counts || { masculino: 0, femenino: 0, mixto: 0 };
        
        // Create protagonist display
        const confidencePercentage = Math.round(confidence * 100);
        const confidenceClass = confidence > 0.7 ? 'text-success' : confidence > 0.4 ? 'text-warning' : 'text-danger';
        
        protagonistDiv.innerHTML = `
            <div class="protagonist-result">
                <div class="protagonist-badge mb-3">
                    <span class="badge bg-primary fs-6 px-3 py-2">
                        <i class="fas fa-user me-2"></i>
                        ${protagonist}
                    </span>
                </div>
                
                <div class="gender-counts">
                    <div class="row text-center">
                        <div class="col-4">
                            <div class="count-item">
                                <div class="count-number text-primary fw-bold">${counts.masculino}</div>
                                <div class="count-label small text-muted">Masculino</div>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="count-item">
                                <div class="count-number text-success fw-bold">${counts.femenino}</div>
                                <div class="count-label small text-muted">Femenino</div>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="count-item">
                                <div class="count-number text-info fw-bold">${counts.mixto}</div>
                                <div class="count-label small text-muted">Mixto</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    function updateTopicAnalysis() {
        const topicDiv = document.getElementById('topic-analysis');
        if (!topicDiv || !window.data) return;
        
        // Get topic from data
        const analysis = window.data.analysis || {};
        const original = analysis.original || {};
        const contenidoGeneral = original.contenido_general || {};
        const tema = contenidoGeneral.tema;
        
        const topicNames = {
            '1': 'Científica/Investigación',
            '2': 'Comunicación',
            '3': 'De farándula o espectáculo',
            '4': 'Deportiva',
            '5': 'Economía',
            '6': 'Educación/cultura',
            '7': 'Empleo/Trabajo',
            '8': 'Empresa',
            '9': 'Judicial',
            '10': 'Medioambiente',
            '11': 'Policial',
            '12': 'Política',
            '13': 'Salud',
            '14': 'Social',
            '15': 'Tecnología',
            '16': 'Transporte',
            '17': 'Otros'
        };
        
        if (tema) {
            const topicName = topicNames[tema] || 'Tema no identificado';
            
            topicDiv.innerHTML = `
                <div class="topic-result">
                    <div class="topic-badge mb-3">
                        <span class="badge bg-success fs-6 px-3 py-2">
                            <i class="fas fa-tag me-2"></i>
                            ${topicName}
                        </span>
                    </div>
                    <div class="topic-code">
                        <small class="text-muted">Código: ${tema}</small>
                    </div>
                </div>
            `;
        } else {
            topicDiv.innerHTML = `
                <div class="topic-result">
                    <div class="no-topic">
                        <i class="fas fa-question-circle text-muted mb-2"></i>
                        <p class="text-muted mb-0">Tema no identificado</p>
                    </div>
                </div>
            `;
        }
    }
</script>

<!-- External Scripts -->
<script type="module" src="{{ url_for('static', filename='js/accordion.js') }}"></script>
<script type="module" src="{{ url_for('static', filename='js/highlight_prediction.js') }}"></script>
<script type="module" src="{{ url_for('static', filename='js/highlight_tooltip.js') }}"></script>
<script type="module" src="{{ url_for('static', filename='js/highlight_human.js') }}"></script>
<script src="{{ url_for('static', filename='js/analysis.js') }}"></script>

<link rel="stylesheet" href="{{ url_for('static', filename='css/analysis.css') }}">


{% endblock %}
